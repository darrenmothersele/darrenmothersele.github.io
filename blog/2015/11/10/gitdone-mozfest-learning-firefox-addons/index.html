<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GitDone, MozFest 2015, and Learning Firefox WebExtensions | Darren Mothersele</title>
</head>
<body>

<div class="home-logo">
  <a href="/">
<img src="/img/daz-logo.png" alt="Daz Logo" class="home-logo-img">
</a>
</div>

<hgroup class="alignCenter">
  <h1>GitDone, MozFest 2015, and Learning Firefox WebExtensions</h1>
        <h6>Nov 10, 2015 · By Darren Mothersele</h6>
  <p class="sc">web-dev</p>
</hgroup>
<p>At Mozfest this last weekend I joined Matt Thompson
<a href="https://twitter.com/openmatt">@OpenMatt</a> and
Phillip Smith <a href="https://twitter.com/phillipadsmith">@phillipadsmith</a> hacking on
an idea make GitHub more accessible for non-technical users.</p>

<p>This was my first time playing around with WebExtensions in FireFox.
It’s still all quite new, and there’s <a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions">minimal documentation</a>, but during the
weekend at <a href="https://2015.mozillafestival.org/">MozFest</a>, we pieced together a working Firefox
extension <a href="https://github.com/OpenMatt/GitDone">GitDone</a>.</p>

<!--break-->

<p>The approach we took was to rewrite bits of the GitHub interface
using a Firefox Addon. Hiding bits, moving bits from one page to another, or rewriting
bits of the interface. To do this we used an extension to inject CSS and JS
into the page. This is not usually a good idea, it’s very fragile. By doing
this we are coding against private details internal to GitHub’s implementation
and not a public published API. Building against APIs is good, because it’s like
a contract, and changes are managable, but with this approach GitHub could
change things at any point and break our code. A better approach would be to
build a new UI and then integrate with GitHub via their API.</p>

<p>But, fragility doesn’t matter here, as the priority is getting something working
so we can test out ideas. I don’t see the technology as an issue in this case,
it’s more about understanding what would make GitHub issues easier and more
efficient for project managers.</p>

<p>We got a first very basic prototype hacked together during Mozfest, and I
hope we’ll continue to develop it as we get feedback from users, but the most
interesting thing for me was that it introduced me to the new Firefox addon
mechanism, based on WebExtensions (so similar to Chrome and Opera).</p>

<h2 id="limitation-and-learning">Limitation and learning</h2>

<p>At first it seemed so easy. I imagined a very trivial, almost vacuous, addon.
<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions">WebExtensions</a> has support for
<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/Content_scripts">Content Scripts</a>
that “runs in the context of a particular web page”. We can define a CSS file
and a URL pattern, such that the CSS file will be injected into pages that
match the URL pattern. You can see this in action in our
first experiment <a href="https://github.com/OpenMatt/GitDone/commit/bf18807d23e8efa7628558672b3c4202e394ecb5">(commit #bf18807)</a>.
Great! We can simplify the interface by hiding something things. So, now we
move on to moving things and rewriting things? Well, unfortunately not.
It turns out it’s not this easy.</p>

<p>GitHub uses <a href="https://github.com/defunkt/jquery-pjax">pjax</a> to deliver a faster browsing experience. It combines
ajax loading and <a href="https://developer.mozilla.org/en-US/docs/Web/API/History_API">pushState</a>
to respond to clicks and load in new content while still maintaining permalinks,
page titles, and browser back button functionality.</p>

<p>This breaks our simple content script based CSS injection, because it only
gets loaded in on the first GitHub page we access. This causes issues when we
want to do different rewritings of the UI on different pages. We need to react
to the pjax events that pull in new content.</p>

<h2 id="isolated-worlds">Isolated worlds</h2>

<p>It took a bit of randomly experimenting and randomly searching documentation to
work out why this wasn’t working. Being new to Firefox addons, I was quickly
having to learn where to find information, how to debug, etc. The frustration
was that I could inject code via the console, react to pjax events and see it
all working, but I couldn’t do the same from a Content Script loaded via the
WebExtension.</p>

<p>The answer came when I realised that the Content Script and the web page run
in “isolated worlds”. They have the same copy of the DOM, but outside of this
the Javascript environments don’t overlap. The pjax events were happening in
the page context, and not visible to the Content Script.</p>

<h2 id="get-out-of-jail-card">Get out of jail card</h2>

<p>I would later find
out that regular DOM Events (non-jQuery) bubble up fine and can trigger event
handlers in either of the “worlds”. But, for the first working version, it
was enough to use the DOM to “inject” our Javascript into the DOM so it could
run in the same “world” as the GitHub page Javascript, and thus do our
rewritings of the UI based off the pjax events fired there.
To do this, we use a Content Script, <code class="highlighter-rouge">injector.js</code> that just injects our
script into page, via the DOM:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>var s = document.createElement('script');
s.src = chrome.extension.getURL('scripts/bootstrap.js');
s.onload = function() {
    this.parentNode.removeChild(this);
};
(document.head || document.documentElement).appendChild(s);
</code></pre>
</div>

<p>For <a href="https://github.com/OpenMatt/GitDone/tree/v0.1">v 0.1</a> it was enough to
inject the main JS, and do the rewriting in the “world” of the GitHub page.
This is isolated from the Content Script that injects it. Unfortunately,
in the GitHub world, the JS is not an extension (addon) anymore, so it doesn’t
have access to the WebExtension APIs of Firefox. The Content Script does, and
can communicate with a “background script” to persist data in local storage,
create notifications, etc.</p>

<h2 id="isolated-worlds-1">Isolated worlds</h2>

<p>In a WebExtension the background script has full access to the APIs for local
storage, generating notifications, etc. The Content Script has limited access
but can use the features by communicating with the background script. This is
done by <a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/Content_scripts#Communicating_with_background_scripts">sending messages</a> and
listening for message events.</p>

<p>If our injected JS running in the GitHub page needs to access these features, it
first needs a way to communicate back to the Content Script that injected it.
The two scripts are in separate “isolated worlds” but they share the DOM of the
page, so we can do this using regular DOM events (jQuery events didn’t seem to
work in my tests).</p>

<p>For example, in the injected JS we can react to a jQuery event, and turn it
into a DOM event:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// in injected JS
// Add out listener to pjax events
$(document).ready(function () {
  $(document).on("pjax:end", function (e) {
    var applyModsEvent = document.createEvent('CustomEvent');
    applyModsEvent.initCustomEvent('gitdone:apply', true, true, {
      activeRoute: document.URL
    });
    document.dispatchEvent(applyModsEvent);
  });
});
</code></pre>
</div>

<p>And, in the injector Content Script listen for the event:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// in content script
window.addEventListener("gitdone:apply", applyModsEventHandler);
function applyModsEventHandler(e) {
  console.log('Apply modifications for ' + e.detail.activeRoute);
}
</code></pre>
</div>

<p>The injected JS can’t communicate with the background script, but the content
script can. In the content script you send a message event:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// in content script
chrome.runtime.sendMessage({msg: "init"});
</code></pre>
</div>

<p>Which you can react to in the background script:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// in background.js
chrome.runtime.onMessage.addListener(function (message, sender) {

});
</code></pre>
</div>

<p>And, in the background script, send messages back to the Content Script:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// in background.js
chrome.tabs.sendMessage(sender.tab.id, state.gitdone);
</code></pre>
</div>

<p>Which the content script can receive:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// in content script
chrome.runtime.onMessage.addListener(function (message, sender) {
}
</code></pre>
</div>

<h2 id="conclusion">Conclusion</h2>

<p>So that solves the issue of communicating across the three scripts. We have the
injected script, running in the Github page catching pjax events. The content script,
sharing the DOM with the Github page but separate JS world. The content script
injects the separate js script into the page via a script tag on the DOM. Communication
across this barrier is via DOM events.</p>

<p>We also have the background script, having access to all the WebExtension APIs
like local storage, notifications, etc. The content script and background
script communicate via message events on <code class="highlighter-rouge">chrome.runtime</code>.</p>

<p>Useful learnings, and hopefully <a href="https://github.com/OpenMatt/GitDone">GitDone</a>
will develop into something useful too.</p>





<div class="author-line">

  <figure class="author-image">
    <img src="/img/darren100.jpg" alt="Darren's Photo" class="avatar">
  </figure>

<h4>Darren Mothersele</h4>
<p>Darren is a software developer who builds simple, creative, and independent technology. He believes this will empower humans to create a better future. <a href="/about">Read more &raquo;</a></p>
</div>


<div class="alignCenter">
  <p class="sc">Responses</p>
</div>
<p>I've removed the Disqus commenting system from my site
  to prevent your browsing activity being sent to a third party.
  No tracking is used on this site.
</p>
<p>Please bear with me while I implement a replacement
  (based on <a href="https://www.w3.org/TR/webmention/">Webmention</a>).
I will be porting over previous comments.
For now, if you want to comment, please
<a href="/contact">get in touch</a>.</p>



<footer>
  <p>
    <small>
      &copy;2007-2016 <a href="/about">Darren Mothersele</a>.
        <a class="text-white" href="http://creativecommons.org/licenses/by-sa/4.0/">Some rights reserved</a>.
        <a href="/contact">Contact</a>
    </small>
  </p>
</footer>
  <link rel="stylesheet" href="/css/styles.css">
</body>
</html>
