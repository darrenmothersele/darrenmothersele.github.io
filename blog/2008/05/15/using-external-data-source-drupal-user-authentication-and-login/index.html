<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Using an external data source for Drupal user authentication and login | Darren Mothersele</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

<div class="home-logo">
  <a href="/">
<img src="/img/daz-logo.png" alt="Daz Logo" class="home-logo-img">
</a>
</div>

<hgroup class="alignCenter">
  <h1>Using an external data source for Drupal user authentication and login</h1>
        <h6>May 15, 2008 · By Darren Mothersele</h6>
  <p class="sc">web-dev</p>
</hgroup>
<p><strong>Update:</strong> This information is not applicable to Drupal 6. To use an external data source for authentication in Drupal 6 you need to use hook_form_alter to add your own validation function to the login form. The two functions below are intended as an outline of how it was done in Drupal 5. You only need these two hooks to extend the authentication - anything further than this will be specific to your requirements.</p>
<p>You can use any database table to validate users for your Drupal site. In this case I'm validating users against a database of clients. This client database is maintained outside of Drupal. It's a simple two step process, and just needs a couple of PHP functions in a custom module: </p>

<!--break-->
<p><b>Step One:</b> hook_auth() puts our own authentication code into the Drupal authentication process, we return true to validate a user, or false if the credentials don't match. If we have successfully authenticated someone then we also set a global variable that we can check in the next step.</p>
<p><b>Step Two:</b> hook_user() allows us to put our own code into the user creation process. When a new user is authenticated Drupal will create a local user object for them. We hook into this process to fill in their details.</p>
<p></p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/**<br /> * Implementation of hook_auth()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">modulename_auth</span><span style="color: #007700">(</span><span style="color: #0000BB">$username</span><span style="color: #007700">, </span><span style="color: #0000BB">$pass</span><span style="color: #007700">, </span><span style="color: #0000BB">$server</span><span style="color: #007700">) {<br />  </span><span style="color: #FF8000">// Does username exist in our clients database?<br />  </span><span style="color: #0000BB">$results </span><span style="color: #007700">= </span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT login, password FROM clients WHERE login = '%s' AND password = '%s'"</span><span style="color: #007700">,</span><span style="color: #0000BB">$username</span><span style="color: #007700">,</span><span style="color: #0000BB">$pass</span><span style="color: #007700">);<br />  </span><span style="color: #0000BB">$row1 </span><span style="color: #007700">= </span><span style="color: #0000BB">db_fetch_array</span><span style="color: #007700">(</span><span style="color: #0000BB">$results</span><span style="color: #007700">);<br />  if (</span><span style="color: #0000BB">$row1</span><span style="color: #007700">) {<br />     global </span><span style="color: #0000BB">$modulename_authenticated</span><span style="color: #007700">;<br />     </span><span style="color: #0000BB">$modulename_authenticated </span><span style="color: #007700">= </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">;<br />     return </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">;<br />  }<br />  else {<br />     return </span><span style="color: #0000BB">FALSE</span><span style="color: #007700">;<br />  }<br />}<br /><br /></span><span style="color: #FF8000">/**<br /> * Implementation of hook_user()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">modulename_user</span><span style="color: #007700">(</span><span style="color: #0000BB">$op</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$edit</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$account</span><span style="color: #007700">, </span><span style="color: #0000BB">$category </span><span style="color: #007700">= </span><span style="color: #0000BB">NULL</span><span style="color: #007700">) {<br />  switch(</span><span style="color: #0000BB">$op</span><span style="color: #007700">) {<br />     case </span><span style="color: #DD0000">'insert'</span><span style="color: #007700">:<br />        </span><span style="color: #FF8000">// a new user is being added; check if we did authentication,<br />        </span><span style="color: #007700">global </span><span style="color: #0000BB">$modulename_authenticated</span><span style="color: #007700">;<br />        if (</span><span style="color: #0000BB">$modulename_authenticated</span><span style="color: #007700">) {<br />          </span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">db_result</span><span style="color: #007700">(</span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT email FROM clients WHERE login = '%s'"</span><span style="color: #007700">,</span><span style="color: #0000BB">$account</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">name</span><span style="color: #007700">));<br />          </span><span style="color: #FF8000">// Set email address in the user table for this user<br />          // You might want to set up some other parts of the user record here too<br />          </span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"UPDATE {users} SET mail = '%s', name = '%s' WHERE uid = %d"</span><span style="color: #007700">, </span><span style="color: #0000BB">$result</span><span style="color: #007700">, </span><span style="color: #0000BB">$account</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">name</span><span style="color: #007700">, </span><span style="color: #0000BB">$account</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">uid</span><span style="color: #007700">);<br />        }<br />  }<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p><strong>Update:</strong></p>
<p>To create this as a module, you need two files:</p>
<p>modulename.info<br />
modulename.module</p>
<p>You save these files in a folder called modulename somewhere within the Drupal module include path. For example in /sites/all/modules/modulename</p>
<p>The first of these files contains the basic module information. This can be as basic as this...</p>
<p>name = modulename<br />
description = what your module does<br />
package = Other</p>
<p>You then put the PHP code for the hooks you wish to implement into the *.module file. Hooks are documented on api.drupal.org. All your hooks start with the module name, as per the config file, and your filenames. For this example the content of the modulename.module file would be as follows:</p>
<p></p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/**<br />* Implementation of hook_auth()<br />*/<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">modulename_auth</span><span style="color: #007700">(</span><span style="color: #0000BB">$username</span><span style="color: #007700">, </span><span style="color: #0000BB">$pass</span><span style="color: #007700">, </span><span style="color: #0000BB">$server</span><span style="color: #007700">) {<br /></span><span style="color: #FF8000">// Does username exist in our clients database?<br /></span><span style="color: #0000BB">$results </span><span style="color: #007700">= </span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT login, password FROM clients WHERE login = '%s' AND password = '%s'"</span><span style="color: #007700">,</span><span style="color: #0000BB">$username</span><span style="color: #007700">,</span><span style="color: #0000BB">$pass</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$row1 </span><span style="color: #007700">= </span><span style="color: #0000BB">db_fetch_array</span><span style="color: #007700">(</span><span style="color: #0000BB">$results</span><span style="color: #007700">);<br />if (</span><span style="color: #0000BB">$row1</span><span style="color: #007700">) {<br />global </span><span style="color: #0000BB">$modulename_authenticated</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$modulename_authenticated </span><span style="color: #007700">= </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">;<br />return </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">;<br />}<br />else {<br />return </span><span style="color: #0000BB">FALSE</span><span style="color: #007700">;<br />}<br />}<br /><br /></span><span style="color: #FF8000">/**<br />* Implementation of hook_user()<br />*/<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">modulename_user</span><span style="color: #007700">(</span><span style="color: #0000BB">$op</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$edit</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$account</span><span style="color: #007700">, </span><span style="color: #0000BB">$category </span><span style="color: #007700">= </span><span style="color: #0000BB">NULL</span><span style="color: #007700">) {<br />switch(</span><span style="color: #0000BB">$op</span><span style="color: #007700">) {<br />case </span><span style="color: #DD0000">'insert'</span><span style="color: #007700">:<br /></span><span style="color: #FF8000">// a new user is being added; check if we did authentication,<br /></span><span style="color: #007700">global </span><span style="color: #0000BB">$modulename_authenticated</span><span style="color: #007700">;<br />if (</span><span style="color: #0000BB">$modulename_authenticated</span><span style="color: #007700">) {<br /></span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">db_result</span><span style="color: #007700">(</span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT email FROM clients WHERE login = '%s'"</span><span style="color: #007700">,</span><span style="color: #0000BB">$account</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">name</span><span style="color: #007700">));<br /></span><span style="color: #FF8000">// Set email address in the user table for this user<br />// You might want to set up some other parts of the user record here too<br /></span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"UPDATE {users} SET mail = '%s', name = '%s' WHERE uid = %d"</span><span style="color: #007700">, </span><span style="color: #0000BB">$result</span><span style="color: #007700">, </span><span style="color: #0000BB">$account</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">name</span><span style="color: #007700">, </span><span style="color: #0000BB">$account</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">uid</span><span style="color: #007700">);<br />}<br />}<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>You will need to adapt the actual authentication code to match your requirements.</p>
<p><strong>Update 2:</strong></p>
<p>The normal login process will call your custom authentication when the built in login process fails.</p>
<p>The process is as follows:</p>
<ul><li>user submits login information</li>
<li>drupal checks if user is blocked, if so message is displayed and login fails</li>
<li>drupal then attempts to load the user locally
<ul><li> if this is successful then the user object is loaded and drupal fires the load and login hooks. the user is then directed towards the 'user' page.</li>
<li>    if user is not found locally then drupal will call external authentication</li>
</ul></li>
</ul>
<p>External authentication involves firing the auth hook, and on success either validating an existing user or creating a new user object. When a user is created this way a record is stored in the authmap table that confirms which module validates this user login.</p>



<div class="author-line">

  <figure class="author-image">
    <img src="/img/darren100.jpg" alt="Darren's Photo" class="avatar">
  </figure>

<h4>Darren Mothersele</h4>
<p>Darren is a software developer who builds simple, creative, and independent technology. He believes this will empower humans to create a better future. <a href="/about">Read more &raquo;</a></p>
</div>


<div class="alignCenter">
  <p class="sc">Responses</p>
</div>
<p>I've removed the Disqus commenting system from my site
  to prevent your browsing activity being sent to a third party.
  No tracking is used on this site.
</p>
<p>Please bear with me while I implement a replacement
  (based on <a href="https://www.w3.org/TR/webmention/">Webmention</a>).
I will be porting over previous comments.
For now, if you want to comment, please
<a href="/contact">get in touch</a>.</p>



<footer>
  <p>
    <small>
      &copy;2007-2016 <a href="/about">Darren Mothersele</a>.
        <a class="text-white" href="http://creativecommons.org/licenses/by-sa/4.0/">Some rights reserved</a>.
        <a href="/contact">Contact</a>
    </small>
  </p>
</footer>
</body>
</html>
