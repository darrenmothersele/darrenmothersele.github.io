<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Facebook Graph API with Drupal Feeds | Darren Mothersele</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-grey-lightest text-black">

<header class="py-4 overflow-hidden flex justify-center items-center border-b">
  <div class="flex-1 border-r h-8 skew-right grad-right"></div>
  <a class="no-outline" href="/">
    <svg id="logo" class="h-8 mx-8" viewBox="0 0 1140 400" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;"><path d="M60,300l60,100l-120,0l60,-100Z" style="fill:#b35738;"/><path d="M120,200l60,100l-120,0l60,-100Z" style="fill:#cf7038;"/><path d="M180,100l60,100l-120,0l60,-100Z" style="fill:#c46f3c;"/><path d="M240,0l60,100l-120,0l60,-100Z" style="fill:#d5a246;"/><path d="M360,0l60,100l-120,0l60,-100Z" style="fill:#ddc55e;"/><path d="M480,0l60,100l-120,0l60,-100Z" style="fill:#d8c571;"/><path d="M420,100l60,100l-120,0l60,-100Z" style="fill:#d5b74c;"/><path d="M180,300l60,100l-120,0l60,-100Z" style="fill:#da7535;"/><path d="M300,300l60,100l-120,0l60,-100Z" style="fill:#dd8d3d;"/><path d="M360,200l60,100l-120,0l60,-100Z" style="fill:#dda446;"/><path d="M420,300l60,100l-120,0l60,-100Z" style="fill:#826c85;"/><path d="M480,200l60,100l-120,0l60,-100Z" style="fill:#b8415b;"/><path d="M540,100l60,100l-120,0l60,-100Z" style="fill:#db3846;"/><path d="M600,0l60,100l-120,0l60,-100Z" style="fill:#e65041;"/><path d="M660,100l60,100l-120,0l60,-100Z" style="fill:#e92d41;"/><path d="M540,300l60,100l-120,0l60,-100Z" style="fill:#ce5772;"/><path d="M660,300l60,100l-120,0l60,-100Z" style="fill:#e7536b;"/><path d="M720,200l60,100l-120,0l60,-100Z" style="fill:#da2451;"/><path d="M780,300l60,100l-120,0l60,-100Z" style="fill:#c74a62;"/><path d="M840,200l60,100l-120,0l60,-100Z" style="fill:#02aeb0;"/><path d="M900,300l60,100l-120,0l60,-100Z" style="fill:#08a4a5;"/><path d="M960,400l60,-100l-120,0l60,100Z" style="fill:#0a969f;"/><path d="M840,400l60,-100l-120,0l60,100Z" style="fill:#05a9a9;"/><path d="M720,400l60,-100l-120,0l60,100Z" style="fill:#e62e4f;"/><path d="M600,400l60,-100l-120,0l60,100Z" style="fill:#e23a57;"/><path d="M480,400l60,-100l-120,0l60,100Z" style="fill:#a7506b;"/><path d="M240,400l60,-100l-120,0l60,100Z" style="fill:#dc8b3a;"/><path d="M360,400l60,-100l-120,0l60,100Z" style="fill:#dd9442;"/><path d="M120,400l60,-100l-120,0l60,100Z" style="fill:#cf6636;"/><path d="M180,300l60,-100l-120,0l60,100Z" style="fill:#d6883c;"/><path d="M240,200l60,-100l-120,0l60,100Z" style="fill:#d08a42;"/><path d="M300,100l60,-100l-120,0l60,100Z" style="fill:#ddbb49;"/><path d="M420,100l60,-100l-120,0l60,100Z" style="fill:#d1bd56;"/><path d="M480,200l60,-100l-120,0l60,100Z" style="fill:#d6bf61;"/><path d="M420,300l60,-100l-120,0l60,100Z" style="fill:#d9af48;"/><path d="M540,300l60,-100l-120,0l60,100Z" style="fill:#d1354f;"/><path d="M600,200l60,-100l-120,0l60,100Z" style="fill:#e53843;"/><path d="M660,300l60,-100l-120,0l60,100Z" style="fill:#d80b2c;"/><path d="M780,100l60,-100l-120,0l60,100Z" style="fill:#128c83;"/><path d="M900,100l60,-100l-120,0l60,100Z" style="fill:#12617a;"/><path d="M960,200l60,-100l-120,0l60,100Z" style="fill:#09889a;"/><path d="M900,300l60,-100l-120,0l60,100Z" style="fill:#03a4ae;"/><path d="M1080,400l60,-100l-120,0l60,100Z" style="fill:#107a8e;"/><path d="M1020,300l60,100l-120,0l60,-100Z" style="fill:#0d8b96;"/><path d="M900,100l60,100l-120,0l60,-100Z" style="fill:#04a1a9;"/><path d="M960,0l60,100l-120,0l60,-100Z" style="fill:#125776;"/><path d="M840,0l60,100l-120,0l60,-100Z" style="fill:#0d8088;"/><path d="M720,0l60,100l-120,0l60,-100Z" style="fill:#169b8c;"/></svg>
  </a>
  <div class="flex-1 border-l h-8 skew-left grad-left"></div>
</header>

<div id="me">
  <div class="py-8 flex justify-center items-center">
    <div class="border rounded-full p-1">
      <img class="rounded-full block" width="100" height="100"
           src="/images/darren100.jpg">
    </div>
  </div>

  <div class="text-center">

    <h1 class="text-2xl">Darren Mothersele</h1>

    <p>Software Developer</p>

  </div>
</div>

<div id="page" class="my-8 font-serif leading-normal">
  <div>
  <p class="border-4 border-red p-8 bg-red-light m-8 text-white">
    <b>Warning:</b> You are viewing old, legacy content.
    Kept for posterity.
    Information is out of date.
    Code samples probably don't work.
    My opinions have probably changed.
    Browse at your own risk.
  </p>
</div>


<div class="m-8">
  <h1>Facebook Graph API with Drupal Feeds</h1>
  
  <p>Oct 4, 2011</p>
  
  
  <p class="text-sm uppercase">web-dev</p>
  
</div>



<div class="m-8 legacy-content font-serif">
  <p>There are several approaches to integrating Drupal with Facebook, the most active modules being <a href="http://drupal.org/project/fbconnect">Facebook Connect</a> and <a href="http://drupal.org/project/fb">Drupal for Facebook</a>. I've been playing around with a slightly different approach that interacts with the Graph API using the Feeds and Rules modules. Read on for more details...</p>

<!--break-->
<p>The first step is connecting to Facebook and linking a Facebook user with a Drupal user. This is handled quite nicely by the FB module, but could be implemented in another way if you feel the FB suite of modules adds too much bloat. You'll need to install the fb_user_app module as this is the module that gives you the access_token you will need to query the Graph API on behalf of a user. You will need to ensure your Facebook App requests the offline_access permission. If you don't have this permission you will find that the access tokens expire after a few minutes, with the offline_access extended permission the tokens don't expire. The access_token is stored in the fb_user_app table of the database (hence the need for the fb_user_app module) and for historical reasons it's stored in a column called "session_key"!</p>
<p>In order to make use of this you need to install the token module and define a couple of user tokens. One to access the user's Facebook ID, and another to get their access token. If you've not defined your own tokens in Drupal before take a look at the Token Starter module included in the Token package. Here's a code snippet that will help:</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">// declare a couple of Tokens:<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">fb_user_tokens_token_list</span><span style="color: #007700">(</span><span style="color: #0000BB">$type </span><span style="color: #007700">= </span><span style="color: #DD0000">'all'</span><span style="color: #007700">) {<br />  </span><span style="color: #0000BB">$tokens </span><span style="color: #007700">= array();<br />  if (</span><span style="color: #0000BB">$type </span><span style="color: #007700">== </span><span style="color: #DD0000">'user'</span><span style="color: #007700">) {<br />    </span><span style="color: #0000BB">$tokens</span><span style="color: #007700">[</span><span style="color: #DD0000">'user'</span><span style="color: #007700">][</span><span style="color: #DD0000">'user-facebook-id'</span><span style="color: #007700">] = </span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">"The Facebook user ID of the user."</span><span style="color: #007700">);<br />    </span><span style="color: #0000BB">$tokens</span><span style="color: #007700">[</span><span style="color: #DD0000">'user'</span><span style="color: #007700">][</span><span style="color: #DD0000">'user-facebook-access-token'</span><span style="color: #007700">] = </span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">"The Facebook access token of the user"</span><span style="color: #007700">);<br />  }<br />  return </span><span style="color: #0000BB">$tokens</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #FF8000">// Look up the values for the tokens:<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">fb_user_tokens_token_values</span><span style="color: #007700">(</span><span style="color: #0000BB">$type</span><span style="color: #007700">, </span><span style="color: #0000BB">$object </span><span style="color: #007700">= </span><span style="color: #0000BB">NULL</span><span style="color: #007700">, </span><span style="color: #0000BB">$options </span><span style="color: #007700">= array()) {<br />  </span><span style="color: #0000BB">$values </span><span style="color: #007700">= array();<br />  if (</span><span style="color: #0000BB">$type </span><span style="color: #007700">== </span><span style="color: #DD0000">'user' </span><span style="color: #007700">&amp;&amp; !empty(</span><span style="color: #0000BB">$object</span><span style="color: #007700">)) {<br />    </span><span style="color: #0000BB">$facebook_id </span><span style="color: #007700">= </span><span style="color: #0000BB">db_result</span><span style="color: #007700">(</span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT fbu FROM {fb_user} WHERE uid = %d"</span><span style="color: #007700">, </span><span style="color: #0000BB">$object</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">uid</span><span style="color: #007700">));<br />    if (!empty(</span><span style="color: #0000BB">$facebook_id</span><span style="color: #007700">)) {<br />      </span><span style="color: #0000BB">$facebook_access_token </span><span style="color: #007700">= </span><span style="color: #0000BB">db_result</span><span style="color: #007700">(</span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT session_key FROM {fb_user_app} WHERE fbu = %d"</span><span style="color: #007700">, </span><span style="color: #0000BB">$facebook_id</span><span style="color: #007700">));<br />    } else {<br />      </span><span style="color: #0000BB">$facebook_access_token </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">;<br />    }<br />    </span><span style="color: #0000BB">$values</span><span style="color: #007700">[</span><span style="color: #DD0000">'user-facebook-id'</span><span style="color: #007700">] = </span><span style="color: #0000BB">$facebook_id</span><span style="color: #007700">;<br />    </span><span style="color: #0000BB">$values</span><span style="color: #007700">[</span><span style="color: #DD0000">'user-facebook-access-token'</span><span style="color: #007700">] = </span><span style="color: #0000BB">$facebook_access_token</span><span style="color: #007700">;<br />  }<br />  return </span><span style="color: #0000BB">$values</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>You then need to install and configure <a href="http://drupal.org/project/feeds">Feeds</a>, in order to fetch content from the Graph API, parse it and then process it. The bit of this that I couldn't find a module for was fetching content from a tokenized URL. Use the <a href="http://developers.facebook.com/tools/explorer">Facebook Graph Explorer</a> to see what URLs you need to hit to get the data you need. Also, check if you need any specific permissions. The URLs look something like this:</p>
<p></p><div class="codeblock"><code>https://graph.facebook.com/[FB_ID]/friends?access_token=[ACCESS_TOKEN] </code></div>
<p>In order to construct the actual URL the two tokens defined previously are required. I created a simple Feeds fetcher plugin that allows you to use tokens in the URL. I would post this as a module, but it's no where near finished quality. Here is the class, it works, but it's not finished:</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">class </span><span style="color: #0000BB">FeedsTokenizedFetcher </span><span style="color: #007700">extends </span><span style="color: #0000BB">FeedsFetcher </span><span style="color: #007700">{<br />  public function </span><span style="color: #0000BB">fetch</span><span style="color: #007700">(</span><span style="color: #0000BB">FeedsSource $source</span><span style="color: #007700">) {<br />    </span><span style="color: #0000BB">$feed_node </span><span style="color: #007700">= </span><span style="color: #0000BB">node_load</span><span style="color: #007700">(</span><span style="color: #0000BB">$source</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">feed_nid</span><span style="color: #007700">);<br />    </span><span style="color: #0000BB">$account </span><span style="color: #007700">= </span><span style="color: #0000BB">user_load</span><span style="color: #007700">(</span><span style="color: #0000BB">$feed_node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">uid</span><span style="color: #007700">);<br />    </span><span style="color: #0000BB">$url </span><span style="color: #007700">= </span><span style="color: #0000BB">token_replace_multiple</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">config</span><span style="color: #007700">[</span><span style="color: #DD0000">'tokenized_url'</span><span style="color: #007700">], array(</span><span style="color: #DD0000">'user' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">$account</span><span style="color: #007700">));<br />    </span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">drupal_http_request</span><span style="color: #007700">(</span><span style="color: #0000BB">$url</span><span style="color: #007700">);<br />    if (</span><span style="color: #0000BB">$result</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">code </span><span style="color: #007700">== </span><span style="color: #0000BB">200</span><span style="color: #007700">) {<br />      return new </span><span style="color: #0000BB">FeedsImportBatch</span><span style="color: #007700">(</span><span style="color: #0000BB">$result</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">data</span><span style="color: #007700">, </span><span style="color: #0000BB">$source</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">feed_nid</span><span style="color: #007700">);<br />    } else {<br />      </span><span style="color: #FF8000">// oops... error!<br />      </span><span style="color: #007700">return new </span><span style="color: #0000BB">FeedsImportBatch</span><span style="color: #007700">(</span><span style="color: #DD0000">''</span><span style="color: #007700">, </span><span style="color: #0000BB">$source</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">feed_nid</span><span style="color: #007700">);<br />    }<br />  }<br />  public function </span><span style="color: #0000BB">configDefaults</span><span style="color: #007700">() {<br />    return array(</span><span style="color: #DD0000">'tokenized_url' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">''</span><span style="color: #007700">);<br />  }<br />  public function </span><span style="color: #0000BB">configForm</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$form_state</span><span style="color: #007700">) {<br />    </span><span style="color: #0000BB">$form </span><span style="color: #007700">= array();<br />    </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'tokenized_url'</span><span style="color: #007700">] = array(<br />      </span><span style="color: #DD0000">'#type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'textarea'</span><span style="color: #007700">,<br />      </span><span style="color: #DD0000">'#title' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">'Tokenized URL'</span><span style="color: #007700">),<br />      </span><span style="color: #DD0000">'#description' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">'The URL that data will be fetched from. All tokens will be replaced before the HTTP call is made.'</span><span style="color: #007700">),<br />      </span><span style="color: #DD0000">'#default_value' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">config</span><span style="color: #007700">[</span><span style="color: #DD0000">'tokenized_url'</span><span style="color: #007700">],<br />    );<br />    </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'tokenized_help'</span><span style="color: #007700">] = array(<br />      </span><span style="color: #DD0000">'#type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'markup'</span><span style="color: #007700">,<br />      </span><span style="color: #DD0000">'#value' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">theme</span><span style="color: #007700">(</span><span style="color: #DD0000">'token_help'</span><span style="color: #007700">, </span><span style="color: #DD0000">'user'</span><span style="color: #007700">),<br />    );<br />    return </span><span style="color: #0000BB">$form</span><span style="color: #007700">;<br />  }<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>So, use this as the fetcher plugin for Feeds, then grab the <a href="http://drupal.org/project/feeds_jsonpath_parser">JSONpath parser</a> plugin for Feeds and use that to parser the JSON object that is returned from the Graph API. You can then use any mapping plugin to process the result, for example the node mapper if you want to create a node (profile node?) from the result, or the data mapper would be a good idea if you're expecting to collect a lot of data (friends lists?). </p>
<p>I attached this Feed Importer configuration to a node, and set up a <a href="http://drupal.org/project/rules">Rule</a> to automatically create one of these every time a user registered on the site using Facebook. This nicely automates the whole process. </p>
<p>The next step is to look at using Rules to automate making POSTs to the Graph API. I'll be sure to blog again if I make any more progress with this methodology.</p>


</div>

</div>

<nav class="bg-grey-darker p-8 text-center text-sm">
  <ul class="list-reset">
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="/about">About</a>
    </li>
    <li class="mx-2 inline-block text-grey-lighter">&#9679;</li>
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="/contact">Contact</a>
    </li>
    <li class="mx-2 inline-block text-grey-lighter">&#9679;</li>
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="https://medium.com/@dazcyril">Stuff I've written on Medium</a>
    </li>
    <li class="mx-2 inline-block text-grey-lighter">&#9679;</li>
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="/blog">My old blog content</a>
    </li>
  </ul>
</nav>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script>
<script src="/js/scripts.js"></script>
</body>
</html>
