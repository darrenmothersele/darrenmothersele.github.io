<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Using Form Alter hooks with Field API Forms | Darren Mothersele</title>
</head>
<body>

<div class="home-logo">
  <a href="/">
<img src="/img/daz-logo.png" alt="Daz Logo" class="home-logo-img">
</a>
</div>

<hgroup class="alignCenter">
  <h1>Using Form Alter hooks with Field API Forms</h1>
        <h6>Jul 12, 2012 Â· By Darren Mothersele</h6>
  <p class="sc">web-dev</p>
</hgroup>
<p><strong>Update:</strong> As noted in the comments, there is now a hook in core to alter the widget form so you no longer need to do this two step process. This hook was introduced in Drupal core 7.8 and is called <code>hook_field_widget_form_alter</code>. Here is the example below, redone using this hook:</p>
<!--break-->
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function </span><span style="color: #0000BB">custom_field_widget_form_alter</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$element</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$form_state</span><span style="color: #007700">, </span><span style="color: #0000BB">$context</span><span style="color: #007700">) {<br>&nbsp; </span><span style="color: #FF8000">// first check the type of the field to ensure only change the required widget<br>&nbsp; </span><span style="color: #007700">if (</span><span style="color: #0000BB">$context</span><span style="color: #007700">[</span><span style="color: #DD0000">'field'</span><span style="color: #007700">][</span><span style="color: #DD0000">'field_name'</span><span style="color: #007700">] == </span><span style="color: #DD0000">'field_twitter'</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$element</span><span style="color: #007700">[</span><span style="color: #DD0000">'value'</span><span style="color: #007700">][</span><span style="color: #DD0000">'#field_prefix'</span><span style="color: #007700">] = </span><span style="color: #DD0000">'@'</span><span style="color: #007700">;<br>&nbsp; }<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p><strong>Original article:</strong></p>
<p>Customising Drupal forms is easy thanks to <code>hook_form_alter()</code>, unless you're working with form elements generated by Drupal 7's Field API. It's common to do customisations, add jQuery UI behaviours, or even advanced form item manipulation using a form alter hook, and Drupal makes it easy by giving your custom code access to the full form array and form state via the form alter hooks, but when you're dealing with Field API generated form fields, you will find it's not quite enough. The problem is that at the time the form alter hook is executed, the field API items in the form haven't been fully built yet. The solution to this is straight forward, and involves the use of a callback function that is called once the form build process is complete. </p>
<p>In the code examples below replace the word <code>custom</code> with your module name. The first step is to define your form alter hook, as you would with any normal form alter operation. You can do this using <a href="http://api.drupal.org/api/drupal/modules%21system%21system.api.php/function/hook_form_alter/7">hook_form_alter()</a> or <a href="http://api.drupal.org/api/drupal/modules%21system%21system.api.php/function/hook_form_FORM_ID_alter/7">hook_form_FORMID_alter()</a>. The first hook is called for every form that is built on your site, the second allows you to target individual forms. </p>
<p>This example below performs the simple task of adding a field prefix to a textfield. A text field has been created with the purpose of collecting Twitter IDs. It is required to add an '@' symbol before the text field entry box to indicate that the user should just enter their ID without the '@' symbol.</p>
<p>The more generic form alter could be useful if you wanted to adapt items across several different forms. The code could look something like this:</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function </span><span style="color: #0000BB">custom_form_alter</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$form</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$form_state</span><span style="color: #007700">, </span><span style="color: #0000BB">$form_id</span><span style="color: #007700">) {<br>&nbsp; if (isset(</span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'type'</span><span style="color: #007700">]) &amp;&amp; </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'type'</span><span style="color: #007700">][</span><span style="color: #DD0000">'#value'</span><span style="color: #007700">] . </span><span style="color: #DD0000">'_node_form' </span><span style="color: #007700">== </span><span style="color: #0000BB">$form_id</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'field_twitter'</span><span style="color: #007700">][</span><span style="color: #0000BB">LANGUAGE_NONE</span><span style="color: #007700">][</span><span style="color: #0000BB">0</span><span style="color: #007700">][</span><span style="color: #DD0000">'#after_build'</span><span style="color: #007700">][] = </span><span style="color: #DD0000">'_custom_add_twitter_field_prefix'</span><span style="color: #007700">;<br>&nbsp; }<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>Alternatively, to target a specific form you specify the form ID in the function name, for example to target the user profile form (who's form ID is <code>user_profile_form</code>) it would look like this:</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function </span><span style="color: #0000BB">custom_form_user_profile_form_alter</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$form</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$form_state</span><span style="color: #007700">, </span><span style="color: #0000BB">$form_id</span><span style="color: #007700">) {<br>&nbsp; </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'field_twitter'</span><span style="color: #007700">][</span><span style="color: #0000BB">LANGUAGE_NONE</span><span style="color: #007700">][</span><span style="color: #0000BB">0</span><span style="color: #007700">][</span><span style="color: #DD0000">'#after_build'</span><span style="color: #007700">][] = </span><span style="color: #DD0000">'_custom_add_twitter_field_prefix'</span><span style="color: #007700">;<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>The <code>'#after_build'</code> key added to the form array defines a callback function. When the Drupal Form API builds this element of the form array it calls the callback function, passing the element in as an argument. The callback function has to return a new element, or modified version of the argument. Don't expect this callback to work the same as the main form alter hook. In the form alter hook the form is passed in by reference and you modify the $form variable. In this after build callback you <em>have</em> to return a new version of the element. </p>
<p>This example callback adds the field prefix to the twitter field:</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function </span><span style="color: #0000BB">_custom_add_twitter_field_prefix</span><span style="color: #007700">(</span><span style="color: #0000BB">$element</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$form_state</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$element</span><span style="color: #007700">[</span><span style="color: #DD0000">'value'</span><span style="color: #007700">][</span><span style="color: #DD0000">'#field_prefix'</span><span style="color: #007700">] = </span><span style="color: #DD0000">'@'</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp; return </span><span style="color: #0000BB">$element</span><span style="color: #007700">;<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>Debugging help: If you're having issues with your modifications inside the callback function not getting applied to the form, check the structure of the original form by adding a debug line to the form alter. Something like: <code>debug($form, $form_id, TRUE);</code>. This will output the full form array, you can use this just to find the keys of the form array:  <code>debug(array_keys($form), $form_id, TRUE);</code>. In the case of these Field API form items notice how the code above makes use of the LANGUAGE_NONE ('und') constant, and then a [0]. This is to take account of the facility in the form array structure for multilingual and multivalue fields. </p>



<div class="author-line">

  <figure class="author-image">
    <img src="/img/darren100.jpg" alt="Darren's Photo" class="avatar">
  </figure>

<h4>Darren Mothersele</h4>
<p>Darren is a software developer who builds simple, creative, and independent technology. He believes this will empower humans to create a better future. <a href="/about">Read more &raquo;</a></p>
</div>


<div class="alignCenter">
  <p class="sc">Responses</p>
</div>
<p>I've removed the Disqus commenting system from my site
  to prevent your browsing activity being sent to a third party.
  No tracking is used on this site.
</p>
<p>Please bear with me while I implement a replacement
  (based on <a href="https://www.w3.org/TR/webmention/">Webmention</a>).
I will be porting over previous comments.
For now, if you want to comment, please
<a href="/contact">get in touch</a>.</p>



<footer>
  <p>
    <small>
      &copy;2007-2016 <a href="/about">Darren Mothersele</a>.
        <a class="text-white" href="http://creativecommons.org/licenses/by-sa/4.0/">Some rights reserved</a>.
        <a href="/contact">Contact</a>
    </small>
  </p>
</footer>
  <link rel="stylesheet" href="/css/styles.css">
</body>
</html>
