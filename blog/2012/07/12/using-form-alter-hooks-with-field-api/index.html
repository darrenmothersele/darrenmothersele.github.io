<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Using Form Alter hooks with Field API Forms | Darren Mothersele</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-grey-lightest text-black">

<header class="py-4 overflow-hidden flex justify-center items-center border-b">
  <div class="flex-1 border-r h-8 skew-right grad-right"></div>
  <a class="no-outline" href="/">
    <svg id="logo" class="h-8 mx-8" viewBox="0 0 1140 400" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;"><path d="M60,300l60,100l-120,0l60,-100Z" style="fill:#b35738;"/><path d="M120,200l60,100l-120,0l60,-100Z" style="fill:#cf7038;"/><path d="M180,100l60,100l-120,0l60,-100Z" style="fill:#c46f3c;"/><path d="M240,0l60,100l-120,0l60,-100Z" style="fill:#d5a246;"/><path d="M360,0l60,100l-120,0l60,-100Z" style="fill:#ddc55e;"/><path d="M480,0l60,100l-120,0l60,-100Z" style="fill:#d8c571;"/><path d="M420,100l60,100l-120,0l60,-100Z" style="fill:#d5b74c;"/><path d="M180,300l60,100l-120,0l60,-100Z" style="fill:#da7535;"/><path d="M300,300l60,100l-120,0l60,-100Z" style="fill:#dd8d3d;"/><path d="M360,200l60,100l-120,0l60,-100Z" style="fill:#dda446;"/><path d="M420,300l60,100l-120,0l60,-100Z" style="fill:#826c85;"/><path d="M480,200l60,100l-120,0l60,-100Z" style="fill:#b8415b;"/><path d="M540,100l60,100l-120,0l60,-100Z" style="fill:#db3846;"/><path d="M600,0l60,100l-120,0l60,-100Z" style="fill:#e65041;"/><path d="M660,100l60,100l-120,0l60,-100Z" style="fill:#e92d41;"/><path d="M540,300l60,100l-120,0l60,-100Z" style="fill:#ce5772;"/><path d="M660,300l60,100l-120,0l60,-100Z" style="fill:#e7536b;"/><path d="M720,200l60,100l-120,0l60,-100Z" style="fill:#da2451;"/><path d="M780,300l60,100l-120,0l60,-100Z" style="fill:#c74a62;"/><path d="M840,200l60,100l-120,0l60,-100Z" style="fill:#02aeb0;"/><path d="M900,300l60,100l-120,0l60,-100Z" style="fill:#08a4a5;"/><path d="M960,400l60,-100l-120,0l60,100Z" style="fill:#0a969f;"/><path d="M840,400l60,-100l-120,0l60,100Z" style="fill:#05a9a9;"/><path d="M720,400l60,-100l-120,0l60,100Z" style="fill:#e62e4f;"/><path d="M600,400l60,-100l-120,0l60,100Z" style="fill:#e23a57;"/><path d="M480,400l60,-100l-120,0l60,100Z" style="fill:#a7506b;"/><path d="M240,400l60,-100l-120,0l60,100Z" style="fill:#dc8b3a;"/><path d="M360,400l60,-100l-120,0l60,100Z" style="fill:#dd9442;"/><path d="M120,400l60,-100l-120,0l60,100Z" style="fill:#cf6636;"/><path d="M180,300l60,-100l-120,0l60,100Z" style="fill:#d6883c;"/><path d="M240,200l60,-100l-120,0l60,100Z" style="fill:#d08a42;"/><path d="M300,100l60,-100l-120,0l60,100Z" style="fill:#ddbb49;"/><path d="M420,100l60,-100l-120,0l60,100Z" style="fill:#d1bd56;"/><path d="M480,200l60,-100l-120,0l60,100Z" style="fill:#d6bf61;"/><path d="M420,300l60,-100l-120,0l60,100Z" style="fill:#d9af48;"/><path d="M540,300l60,-100l-120,0l60,100Z" style="fill:#d1354f;"/><path d="M600,200l60,-100l-120,0l60,100Z" style="fill:#e53843;"/><path d="M660,300l60,-100l-120,0l60,100Z" style="fill:#d80b2c;"/><path d="M780,100l60,-100l-120,0l60,100Z" style="fill:#128c83;"/><path d="M900,100l60,-100l-120,0l60,100Z" style="fill:#12617a;"/><path d="M960,200l60,-100l-120,0l60,100Z" style="fill:#09889a;"/><path d="M900,300l60,-100l-120,0l60,100Z" style="fill:#03a4ae;"/><path d="M1080,400l60,-100l-120,0l60,100Z" style="fill:#107a8e;"/><path d="M1020,300l60,100l-120,0l60,-100Z" style="fill:#0d8b96;"/><path d="M900,100l60,100l-120,0l60,-100Z" style="fill:#04a1a9;"/><path d="M960,0l60,100l-120,0l60,-100Z" style="fill:#125776;"/><path d="M840,0l60,100l-120,0l60,-100Z" style="fill:#0d8088;"/><path d="M720,0l60,100l-120,0l60,-100Z" style="fill:#169b8c;"/></svg>
  </a>
  <div class="flex-1 border-l h-8 skew-left grad-left"></div>
</header>

<div id="me">
  <div class="py-8 flex justify-center items-center">
    <div class="border rounded-full p-1">
      <img class="rounded-full block" width="100" height="100"
           src="/images/darren100.jpg">
    </div>
  </div>

  <div class="text-center">

    <h1 class="text-2xl">Darren Mothersele</h1>

    <p>Software Developer</p>

  </div>
</div>

<div id="page" class="my-8 font-serif leading-normal">
  <div>
  <p class="border-4 border-red p-8 bg-red-light m-8 text-white">
    <b>Warning:</b> You are viewing old, legacy content.
    Kept for posterity.
    Information is out of date.
    Code samples probably don't work.
    My opinions have probably changed.
    Browse at your own risk.
  </p>
</div>


<div class="m-8">
  <h1>Using Form Alter hooks with Field API Forms</h1>
  
  <p>Jul 12, 2012</p>
  
  
  <p class="text-sm uppercase">web-dev</p>
  
</div>



<div class="m-8 legacy-content font-serif">
  <p><strong>Update:</strong> As noted in the comments, there is now a hook in core to alter the widget form so you no longer need to do this two step process. This hook was introduced in Drupal core 7.8 and is called <code>hook_field_widget_form_alter</code>. Here is the example below, redone using this hook:</p>
<!--break-->
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function </span><span style="color: #0000BB">custom_field_widget_form_alter</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$element</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$form_state</span><span style="color: #007700">, </span><span style="color: #0000BB">$context</span><span style="color: #007700">) {<br>&nbsp; </span><span style="color: #FF8000">// first check the type of the field to ensure only change the required widget<br>&nbsp; </span><span style="color: #007700">if (</span><span style="color: #0000BB">$context</span><span style="color: #007700">[</span><span style="color: #DD0000">'field'</span><span style="color: #007700">][</span><span style="color: #DD0000">'field_name'</span><span style="color: #007700">] == </span><span style="color: #DD0000">'field_twitter'</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$element</span><span style="color: #007700">[</span><span style="color: #DD0000">'value'</span><span style="color: #007700">][</span><span style="color: #DD0000">'#field_prefix'</span><span style="color: #007700">] = </span><span style="color: #DD0000">'@'</span><span style="color: #007700">;<br>&nbsp; }<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p><strong>Original article:</strong></p>
<p>Customising Drupal forms is easy thanks to <code>hook_form_alter()</code>, unless you're working with form elements generated by Drupal 7's Field API. It's common to do customisations, add jQuery UI behaviours, or even advanced form item manipulation using a form alter hook, and Drupal makes it easy by giving your custom code access to the full form array and form state via the form alter hooks, but when you're dealing with Field API generated form fields, you will find it's not quite enough. The problem is that at the time the form alter hook is executed, the field API items in the form haven't been fully built yet. The solution to this is straight forward, and involves the use of a callback function that is called once the form build process is complete. </p>
<p>In the code examples below replace the word <code>custom</code> with your module name. The first step is to define your form alter hook, as you would with any normal form alter operation. You can do this using <a href="http://api.drupal.org/api/drupal/modules%21system%21system.api.php/function/hook_form_alter/7">hook_form_alter()</a> or <a href="http://api.drupal.org/api/drupal/modules%21system%21system.api.php/function/hook_form_FORM_ID_alter/7">hook_form_FORMID_alter()</a>. The first hook is called for every form that is built on your site, the second allows you to target individual forms. </p>
<p>This example below performs the simple task of adding a field prefix to a textfield. A text field has been created with the purpose of collecting Twitter IDs. It is required to add an '@' symbol before the text field entry box to indicate that the user should just enter their ID without the '@' symbol.</p>
<p>The more generic form alter could be useful if you wanted to adapt items across several different forms. The code could look something like this:</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function </span><span style="color: #0000BB">custom_form_alter</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$form</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$form_state</span><span style="color: #007700">, </span><span style="color: #0000BB">$form_id</span><span style="color: #007700">) {<br>&nbsp; if (isset(</span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'type'</span><span style="color: #007700">]) &amp;&amp; </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'type'</span><span style="color: #007700">][</span><span style="color: #DD0000">'#value'</span><span style="color: #007700">] . </span><span style="color: #DD0000">'_node_form' </span><span style="color: #007700">== </span><span style="color: #0000BB">$form_id</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'field_twitter'</span><span style="color: #007700">][</span><span style="color: #0000BB">LANGUAGE_NONE</span><span style="color: #007700">][</span><span style="color: #0000BB">0</span><span style="color: #007700">][</span><span style="color: #DD0000">'#after_build'</span><span style="color: #007700">][] = </span><span style="color: #DD0000">'_custom_add_twitter_field_prefix'</span><span style="color: #007700">;<br>&nbsp; }<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>Alternatively, to target a specific form you specify the form ID in the function name, for example to target the user profile form (who's form ID is <code>user_profile_form</code>) it would look like this:</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function </span><span style="color: #0000BB">custom_form_user_profile_form_alter</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$form</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$form_state</span><span style="color: #007700">, </span><span style="color: #0000BB">$form_id</span><span style="color: #007700">) {<br>&nbsp; </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'field_twitter'</span><span style="color: #007700">][</span><span style="color: #0000BB">LANGUAGE_NONE</span><span style="color: #007700">][</span><span style="color: #0000BB">0</span><span style="color: #007700">][</span><span style="color: #DD0000">'#after_build'</span><span style="color: #007700">][] = </span><span style="color: #DD0000">'_custom_add_twitter_field_prefix'</span><span style="color: #007700">;<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>The <code>'#after_build'</code> key added to the form array defines a callback function. When the Drupal Form API builds this element of the form array it calls the callback function, passing the element in as an argument. The callback function has to return a new element, or modified version of the argument. Don't expect this callback to work the same as the main form alter hook. In the form alter hook the form is passed in by reference and you modify the $form variable. In this after build callback you <em>have</em> to return a new version of the element. </p>
<p>This example callback adds the field prefix to the twitter field:</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function </span><span style="color: #0000BB">_custom_add_twitter_field_prefix</span><span style="color: #007700">(</span><span style="color: #0000BB">$element</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$form_state</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$element</span><span style="color: #007700">[</span><span style="color: #DD0000">'value'</span><span style="color: #007700">][</span><span style="color: #DD0000">'#field_prefix'</span><span style="color: #007700">] = </span><span style="color: #DD0000">'@'</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp; return </span><span style="color: #0000BB">$element</span><span style="color: #007700">;<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>Debugging help: If you're having issues with your modifications inside the callback function not getting applied to the form, check the structure of the original form by adding a debug line to the form alter. Something like: <code>debug($form, $form_id, TRUE);</code>. This will output the full form array, you can use this just to find the keys of the form array:  <code>debug(array_keys($form), $form_id, TRUE);</code>. In the case of these Field API form items notice how the code above makes use of the LANGUAGE_NONE ('und') constant, and then a [0]. This is to take account of the facility in the form array structure for multilingual and multivalue fields. </p>


</div>

</div>

<nav class="bg-grey-darker p-8 text-center text-sm">
  <ul class="list-reset">
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="/about">About</a>
    </li>
    <li class="mx-2 inline-block text-grey-lighter">&#9679;</li>
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="/contact">Contact</a>
    </li>
    <li class="mx-2 inline-block text-grey-lighter">&#9679;</li>
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="https://medium.com/@dazcyril">Stuff I've written on Medium</a>
    </li>
    <li class="mx-2 inline-block text-grey-lighter">&#9679;</li>
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="/blog">My old blog content</a>
    </li>
  </ul>
</nav>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script>
<script src="/js/scripts.js"></script>
</body>
</html>
