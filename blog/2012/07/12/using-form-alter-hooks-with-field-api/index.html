<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title> Using Form Alter hooks with Field API Forms |  Darren Mothersele</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <link rel="alternate" type="application/rss+xml" title="Darren Mothersele" href="http://www.darrenmothersele.com/rss.xml">
    
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>


<header id="header">
    <a href="/" class="image avatar"><img src="/img/darren100.jpg" alt="" /></a>
    <h1>
       <strong>Darren Mothersele</strong> </h1><h1> Creative Technologist
    </h1>

<ul class="menu-list">
    <li><a href="/about/">About me</a></li>
    <li><a href="/blog/">Blog</a></li>
    <li><a href="/contact/">Contact</a></li>
</ul>

</header>

<!-- <header>

<div class="top-nav">

<a href="/" class="top-nav-logo"><img src="/img/daz-logo.png" class="logo" alt="Logo" width="100"></a>

<ul class="menu menu-list">
    <li><a href="/about/">About me</a></li>
    <li><a href="/blog/">Blog</a></li>
    <li><a href="/contact/">Contact</a></li>
</ul>
</div>
<br clear="both">

</header> -->

<div id="main">
<div class="page">
  <header class="post-header">
<h2 class="post-title">Using Form Alter hooks with Field API Forms</h2>

  <p class="">12 Jul 2012</p>

  </header>


            
              <p class="lead"><strong>Update:</strong> As noted in the comments, there is now a hook in core to alter the widget form so you no longer need to do this two step process. This hook was introduced in Drupal core 7.8 and is called <code>hook_field_widget_form_alter</code>. Here is the example below, redone using this hook:</p>



              
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function </span><span style="color: #0000BB">custom_field_widget_form_alter</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$element</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$form_state</span><span style="color: #007700">, </span><span style="color: #0000BB">$context</span><span style="color: #007700">) {<br>&nbsp; </span><span style="color: #FF8000">// first check the type of the field to ensure only change the required widget<br>&nbsp; </span><span style="color: #007700">if (</span><span style="color: #0000BB">$context</span><span style="color: #007700">[</span><span style="color: #DD0000">'field'</span><span style="color: #007700">][</span><span style="color: #DD0000">'field_name'</span><span style="color: #007700">] == </span><span style="color: #DD0000">'field_twitter'</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$element</span><span style="color: #007700">[</span><span style="color: #DD0000">'value'</span><span style="color: #007700">][</span><span style="color: #DD0000">'#field_prefix'</span><span style="color: #007700">] = </span><span style="color: #DD0000">'@'</span><span style="color: #007700">;<br>&nbsp; }<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p><strong>Original article:</strong></p>
<p>Customising Drupal forms is easy thanks to <code>hook_form_alter()</code>, unless you're working with form elements generated by Drupal 7's Field API. It's common to do customisations, add jQuery UI behaviours, or even advanced form item manipulation using a form alter hook, and Drupal makes it easy by giving your custom code access to the full form array and form state via the form alter hooks, but when you're dealing with Field API generated form fields, you will find it's not quite enough. The problem is that at the time the form alter hook is executed, the field API items in the form haven't been fully built yet. The solution to this is straight forward, and involves the use of a callback function that is called once the form build process is complete. </p>
<p>In the code examples below replace the word <code>custom</code> with your module name. The first step is to define your form alter hook, as you would with any normal form alter operation. You can do this using <a href="http://api.drupal.org/api/drupal/modules%21system%21system.api.php/function/hook_form_alter/7">hook_form_alter()</a> or <a href="http://api.drupal.org/api/drupal/modules%21system%21system.api.php/function/hook_form_FORM_ID_alter/7">hook_form_FORMID_alter()</a>. The first hook is called for every form that is built on your site, the second allows you to target individual forms. </p>
<p>This example below performs the simple task of adding a field prefix to a textfield. A text field has been created with the purpose of collecting Twitter IDs. It is required to add an '@' symbol before the text field entry box to indicate that the user should just enter their ID without the '@' symbol.</p>
<p>The more generic form alter could be useful if you wanted to adapt items across several different forms. The code could look something like this:</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function </span><span style="color: #0000BB">custom_form_alter</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$form</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$form_state</span><span style="color: #007700">, </span><span style="color: #0000BB">$form_id</span><span style="color: #007700">) {<br>&nbsp; if (isset(</span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'type'</span><span style="color: #007700">]) &amp;&amp; </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'type'</span><span style="color: #007700">][</span><span style="color: #DD0000">'#value'</span><span style="color: #007700">] . </span><span style="color: #DD0000">'_node_form' </span><span style="color: #007700">== </span><span style="color: #0000BB">$form_id</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'field_twitter'</span><span style="color: #007700">][</span><span style="color: #0000BB">LANGUAGE_NONE</span><span style="color: #007700">][</span><span style="color: #0000BB">0</span><span style="color: #007700">][</span><span style="color: #DD0000">'#after_build'</span><span style="color: #007700">][] = </span><span style="color: #DD0000">'_custom_add_twitter_field_prefix'</span><span style="color: #007700">;<br>&nbsp; }<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>Alternatively, to target a specific form you specify the form ID in the function name, for example to target the user profile form (who's form ID is <code>user_profile_form</code>) it would look like this:</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function </span><span style="color: #0000BB">custom_form_user_profile_form_alter</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$form</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$form_state</span><span style="color: #007700">, </span><span style="color: #0000BB">$form_id</span><span style="color: #007700">) {<br>&nbsp; </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'field_twitter'</span><span style="color: #007700">][</span><span style="color: #0000BB">LANGUAGE_NONE</span><span style="color: #007700">][</span><span style="color: #0000BB">0</span><span style="color: #007700">][</span><span style="color: #DD0000">'#after_build'</span><span style="color: #007700">][] = </span><span style="color: #DD0000">'_custom_add_twitter_field_prefix'</span><span style="color: #007700">;<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>The <code>'#after_build'</code> key added to the form array defines a callback function. When the Drupal Form API builds this element of the form array it calls the callback function, passing the element in as an argument. The callback function has to return a new element, or modified version of the argument. Don't expect this callback to work the same as the main form alter hook. In the form alter hook the form is passed in by reference and you modify the $form variable. In this after build callback you <em>have</em> to return a new version of the element. </p>
<p>This example callback adds the field prefix to the twitter field:</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">function </span><span style="color: #0000BB">_custom_add_twitter_field_prefix</span><span style="color: #007700">(</span><span style="color: #0000BB">$element</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$form_state</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$element</span><span style="color: #007700">[</span><span style="color: #DD0000">'value'</span><span style="color: #007700">][</span><span style="color: #DD0000">'#field_prefix'</span><span style="color: #007700">] = </span><span style="color: #DD0000">'@'</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp; return </span><span style="color: #0000BB">$element</span><span style="color: #007700">;<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>Debugging help: If you're having issues with your modifications inside the callback function not getting applied to the form, check the structure of the original form by adding a debug line to the form alter. Something like: <code>debug($form, $form_id, TRUE);</code>. This will output the full form array, you can use this just to find the keys of the form array:  <code>debug(array_keys($form), $form_id, TRUE);</code>. In the case of these Field API form items notice how the code above makes use of the LANGUAGE_NONE ('und') constant, and then a [0]. This is to take account of the facility in the form array structure for multilingual and multivalue fields. </p>

            

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'darrenmothersele';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>







<div class="h-card">

  <a class="p-name u-url" href="http://www.darrenmothersele.com">Darren Mothersele</a>
    <i class="icon">&#128681;</i>
    <span class="p-locality">London</span>, <span class="p-country-name">UK</span>
    <br>
    <i class="icon">&#9993;</i>
  <a class="u-email" href="mailto:darren@darrenmothersele.com">darren@darrenmothersele.com</a>
  <p class="p-note">Creative Technologist</p>

    <img class="u-photo" src="/img/darren100.jpg" alt="" width="40px" />
</div>

<div class="my-tinyletter">
    <h4>Updates...</h4>
<form action="https://tinyletter.com/dazm" method="post">
    <p>
        <label for="tlemail">To get my monthly 'friends and family' newsletter, enter your email address:</label>
    </p>
    <p>
        <input type="text" name="email" id="tlemail" placeholder="Email" /><br>
        <input type="hidden" value="1" name="embed"/>
        <input type="submit" value="Subscribe" /><br>
        <a href="https://tinyletter.com" target="_blank" style="font-size:75%;">
            powered by TinyLetter
        </a>
    </p>
</form>

<p><a href="/indieweb">Am I Indie Yet?</a> <br>
<a href="https://github.com/darrenmothersele/ama">Ask me anything!</a> <br>
No tracking is used on this site.</p>

</div>



</div>
</div>

<!-- <footer>



<div class="footer">

<p>
    <i class="icon">&#128681;</i>
    Brixton, London, UK
    <br>
    <i class="icon">&#9993;</i>
    <script type="text/javascript">
    var data = "&#100;&#97;&#114;&#114;&#101;&#110;&#64;&#100;&#97;&#114;"
    + "&#114;&#101;&#110;&#109;&#111;&#116;&#104;&#101;&#114;&#115;&#101;"
    + "&#108;&#101;&#46;&#99;&#111;&#109;";
    document.write(data);
    </script>
</p>

<div class="my-tinyletter">
<form action="https://tinyletter.com/dazm" method="post">
    <p>
        <label for="tlemail">To get my 'friends and family' newsletter, enter your email address:</label>
    </p>
    <p>
        <input type="text" style="width:140px" name="email" id="tlemail" />
        <input type="hidden" value="1" name="embed"/>
        <input type="submit" value="Subscribe" /><br>
        <a href="https://tinyletter.com" target="_blank" style="font-size:75%;">
            powered by TinyLetter
        </a>
    </p>
</form>
</div>


<ul class="social-icons text-right menu-list hidden-sm">


    <li><a href="https://twitter.com/mothersele"><i class="icon-twitter3"></i> Twitter</a></li>

    <li><a href="https://github.com/darrenmothersele/"><i class="icon-github"></i> GitHub</a></li>

    <li><a href="https://vimeo.com/user437927"><i class="icon-vimeo3"></i> Vimeo</a></li>

    <li><a href="https://uk.linkedin.com/in/dmothersele"><i class="icon-linkedin2"></i> LinkedIn</a></li>


</ul>


<ul class="menu-list">
    <li><a href="/contact/">Contact</a></li>
    <li><a href="/about/">About</a></li>
    <li><a href="/training/">Training</a></li>
    <li><a href="/blog/">Blog</a></li>
</ul>

<p class="sub">
    <small>
        &copy;2007-2015 Darren Mothersele.
        Unless specified otherwise, content is licensed under a
        <a class="text-white" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative
            Commons Attribution-ShareAlike 3.0 Unported License</a>.


        Source code is either released into the public domain, or under
        an MIT / BSD license where possible. If this is not possible
        (due to restrictions of the GPL) then code will be released
        as GPL. See individual project license files for details.
    </small>
</p>
</div>

</footer> -->



<footer id="footer">
    <ul class="icons">
        <li><a href="https://twitter.com/mothersele" rel="me" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
        <li><a href="https://github.com/darrenmothersele" rel="me" class="icon fa-github"><span class="label">Github</span></a></li>
        <li><a href="mailto:darren@darrenmothersele.com" class="icon fa-envelope-o"><span class="label">
    <script type="text/javascript">
    var data = "&#100;&#97;&#114;&#114;&#101;&#110;&#64;&#100;&#97;&#114;"
    + "&#114;&#101;&#110;&#109;&#111;&#116;&#104;&#101;&#114;&#115;&#101;"
    + "&#108;&#101;&#46;&#99;&#111;&#109;";
    document.write(data);
    </script></span></a></li>
    </ul>
    <ul class="copyright">
        <li>
        &copy;2007-2016 Darren Mothersele.
        Unless specified otherwise, content is licensed under a
        <a class="text-white" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative
            Commons Attribution-ShareAlike 3.0 Unported License</a>.</li>
    </ul>
</footer>

</body>
</html>
