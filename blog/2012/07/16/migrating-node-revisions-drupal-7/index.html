<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Migrating Node Revisions to Drupal 7 | Darren Mothersele</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-grey-lightest text-black">

<header class="py-4 overflow-hidden flex justify-center items-center border-b">
  <div class="flex-1 border-r h-8 skew-right grad-right"></div>
  <a class="no-outline" href="/">
    <svg id="logo" class="h-8 mx-8" viewBox="0 0 1140 400" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;"><path d="M60,300l60,100l-120,0l60,-100Z" style="fill:#b35738;"/><path d="M120,200l60,100l-120,0l60,-100Z" style="fill:#cf7038;"/><path d="M180,100l60,100l-120,0l60,-100Z" style="fill:#c46f3c;"/><path d="M240,0l60,100l-120,0l60,-100Z" style="fill:#d5a246;"/><path d="M360,0l60,100l-120,0l60,-100Z" style="fill:#ddc55e;"/><path d="M480,0l60,100l-120,0l60,-100Z" style="fill:#d8c571;"/><path d="M420,100l60,100l-120,0l60,-100Z" style="fill:#d5b74c;"/><path d="M180,300l60,100l-120,0l60,-100Z" style="fill:#da7535;"/><path d="M300,300l60,100l-120,0l60,-100Z" style="fill:#dd8d3d;"/><path d="M360,200l60,100l-120,0l60,-100Z" style="fill:#dda446;"/><path d="M420,300l60,100l-120,0l60,-100Z" style="fill:#826c85;"/><path d="M480,200l60,100l-120,0l60,-100Z" style="fill:#b8415b;"/><path d="M540,100l60,100l-120,0l60,-100Z" style="fill:#db3846;"/><path d="M600,0l60,100l-120,0l60,-100Z" style="fill:#e65041;"/><path d="M660,100l60,100l-120,0l60,-100Z" style="fill:#e92d41;"/><path d="M540,300l60,100l-120,0l60,-100Z" style="fill:#ce5772;"/><path d="M660,300l60,100l-120,0l60,-100Z" style="fill:#e7536b;"/><path d="M720,200l60,100l-120,0l60,-100Z" style="fill:#da2451;"/><path d="M780,300l60,100l-120,0l60,-100Z" style="fill:#c74a62;"/><path d="M840,200l60,100l-120,0l60,-100Z" style="fill:#02aeb0;"/><path d="M900,300l60,100l-120,0l60,-100Z" style="fill:#08a4a5;"/><path d="M960,400l60,-100l-120,0l60,100Z" style="fill:#0a969f;"/><path d="M840,400l60,-100l-120,0l60,100Z" style="fill:#05a9a9;"/><path d="M720,400l60,-100l-120,0l60,100Z" style="fill:#e62e4f;"/><path d="M600,400l60,-100l-120,0l60,100Z" style="fill:#e23a57;"/><path d="M480,400l60,-100l-120,0l60,100Z" style="fill:#a7506b;"/><path d="M240,400l60,-100l-120,0l60,100Z" style="fill:#dc8b3a;"/><path d="M360,400l60,-100l-120,0l60,100Z" style="fill:#dd9442;"/><path d="M120,400l60,-100l-120,0l60,100Z" style="fill:#cf6636;"/><path d="M180,300l60,-100l-120,0l60,100Z" style="fill:#d6883c;"/><path d="M240,200l60,-100l-120,0l60,100Z" style="fill:#d08a42;"/><path d="M300,100l60,-100l-120,0l60,100Z" style="fill:#ddbb49;"/><path d="M420,100l60,-100l-120,0l60,100Z" style="fill:#d1bd56;"/><path d="M480,200l60,-100l-120,0l60,100Z" style="fill:#d6bf61;"/><path d="M420,300l60,-100l-120,0l60,100Z" style="fill:#d9af48;"/><path d="M540,300l60,-100l-120,0l60,100Z" style="fill:#d1354f;"/><path d="M600,200l60,-100l-120,0l60,100Z" style="fill:#e53843;"/><path d="M660,300l60,-100l-120,0l60,100Z" style="fill:#d80b2c;"/><path d="M780,100l60,-100l-120,0l60,100Z" style="fill:#128c83;"/><path d="M900,100l60,-100l-120,0l60,100Z" style="fill:#12617a;"/><path d="M960,200l60,-100l-120,0l60,100Z" style="fill:#09889a;"/><path d="M900,300l60,-100l-120,0l60,100Z" style="fill:#03a4ae;"/><path d="M1080,400l60,-100l-120,0l60,100Z" style="fill:#107a8e;"/><path d="M1020,300l60,100l-120,0l60,-100Z" style="fill:#0d8b96;"/><path d="M900,100l60,100l-120,0l60,-100Z" style="fill:#04a1a9;"/><path d="M960,0l60,100l-120,0l60,-100Z" style="fill:#125776;"/><path d="M840,0l60,100l-120,0l60,-100Z" style="fill:#0d8088;"/><path d="M720,0l60,100l-120,0l60,-100Z" style="fill:#169b8c;"/></svg>
  </a>
  <div class="flex-1 border-l h-8 skew-left grad-left"></div>
</header>

<div id="me">
  <div class="py-8 flex justify-center items-center">
    <div class="border rounded-full p-1">
      <img class="rounded-full block" width="100" height="100"
           src="/images/darren100.jpg">
    </div>
  </div>

  <div class="text-center">

    <h1 class="text-2xl">Darren Mothersele</h1>

    <p>Software Developer</p>

  </div>
</div>

<div id="page" class="my-8 font-serif leading-normal">
  <div>
  <p class="border-4 border-red p-8 bg-red-light m-8 text-white">
    <b>Warning:</b> You are viewing old, legacy content.
    Kept for posterity.
    Information is out of date.
    Code samples probably don't work.
    My opinions have probably changed.
    Browse at your own risk.
  </p>
</div>


<div class="m-8">
  <h1>Migrating Node Revisions to Drupal 7</h1>
  
  <p>Jul 16, 2012</p>
  
  
  <p class="text-sm uppercase">web-dev</p>
  
</div>



<div class="m-8 legacy-content font-serif">
  <p>A while ago I was working on a migration from Open Atrium (Drupal 6) to Drupal 7. I decided to use the <a href="http://drupal.org/project/migrate">Migrate</a> module for this, as it provides a great framework for building migrations. Unfortunately the Migrate module doesn't (at the moment) support migrating of node revisions. There's discussion on the issue queue about migrating revisions <a href="http://drupal.org/node/1298724">here</a>. I quickly hacked together some working code that worked for me. I'm going to assume some prior knowledge of the Migrate module. If it's new to you, check out <a href="http://denver2012.drupal.org/program/sessions/getting-it-drupal-migrate">this presentation</a> from Drupalcon Dever which gives a good overview of the architecture.</p>
<!--break-->
<p>The code below is working for me, and I'm using it to migrate content from Open Atrium to Drupal 7. The code does need some work, as it throws a few warning messages. It still migrates all nodes and revisions successfully, so it's usable if you're not a pedant :).</p>
<p>Migration using the Drupal Migrate module requires you to write some code. You can usually get away with using the provided Migration sources and destination handlers, and just write the code that handles the mapping of fields from source to target. In this case, I couldn't as the project required all history (revisions) to be migrated, and the standard <code>MigrateDestinationNode</code> class doesn't handle this. To get around this I first create a basic extension of the Node destination class to deal with revisions...</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">class </span><span style="color: #0000BB">MigrateDestinationRevision </span><span style="color: #007700">extends </span><span style="color: #0000BB">MigrateDestinationNode </span><span style="color: #007700">{<br>&nbsp; static public function </span><span style="color: #0000BB">getKeySchema</span><span style="color: #007700">() {<br>&nbsp;&nbsp;&nbsp; return array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'vid' </span><span style="color: #007700">=&gt; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'int'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'unsigned' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'description' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'ID of destination node revision'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br>&nbsp;&nbsp;&nbsp; );<br>&nbsp; }<br>&nbsp; public function </span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #0000BB">$migration </span><span style="color: #007700">= </span><span style="color: #0000BB">NULL</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$fields </span><span style="color: #007700">= </span><span style="color: #0000BB">parent</span><span style="color: #007700">::</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #0000BB">$migration</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$fields</span><span style="color: #007700">[</span><span style="color: #DD0000">'vid'</span><span style="color: #007700">] = </span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">'Node: &lt;a href="@doc"&gt;Revision (vid)&lt;/a&gt;'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'@doc' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'http://drupal.org/node/1298724'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp; return </span><span style="color: #0000BB">$fields</span><span style="color: #007700">;<br>&nbsp; }<br>&nbsp; public function </span><span style="color: #0000BB">bulkRollback</span><span style="color: #007700">(array </span><span style="color: #0000BB">$vids</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">migrate_instrument_start</span><span style="color: #007700">(</span><span style="color: #DD0000">'revision_delete_multiple'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">prepareRollback</span><span style="color: #007700">(</span><span style="color: #0000BB">$vids</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; foreach (</span><span style="color: #0000BB">$vids </span><span style="color: #007700">as </span><span style="color: #0000BB">$vid</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (</span><span style="color: #0000BB">$revision </span><span style="color: #007700">= </span><span style="color: #0000BB">node_load</span><span style="color: #007700">(</span><span style="color: #0000BB">NULL</span><span style="color: #007700">, </span><span style="color: #0000BB">$vid</span><span style="color: #007700">)) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">db_delete</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revision'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'vid'</span><span style="color: #007700">, </span><span style="color: #0000BB">$revision</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">vid</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">module_invoke_all</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revision_delete'</span><span style="color: #007700">, </span><span style="color: #0000BB">$revision</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">field_attach_delete_revision</span><span style="color: #007700">(</span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #0000BB">$revision</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">completeRollback</span><span style="color: #007700">(</span><span style="color: #0000BB">$vids</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">migrate_instrument_stop</span><span style="color: #007700">(</span><span style="color: #DD0000">'revision_delete_multiple'</span><span style="color: #007700">);<br>&nbsp; }<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>I'm overriding the key schema to make it aware of <code>vid</code> revision ids, and adding some code to take care of deleting all node revisions when I want to rollback a migration.</p>
<p>I then create the node migration, but instead of migrating the latest versions of the nodes, I craft the SQL so that it migrates all nodes, but does so with their first ever revisions. This migration runs before the revision migration. I create the revision migration and make the node revision migration a dependency of the revision migration. Here's the basics of the node migration, with the detail removed, notice that I'm using an abstract class, I have other concrete classes that instantiate the migration with an actual content type. This allows me to reuse as much mapping code as possible...</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">abstract class </span><span style="color: #0000BB">AtriumNodeMigration </span><span style="color: #007700">extends </span><span style="color: #0000BB">Migration </span><span style="color: #007700">{<br>&nbsp;&nbsp;&nbsp; protected </span><span style="color: #0000BB">$query</span><span style="color: #007700">, </span><span style="color: #0000BB">$subquery</span><span style="color: #007700">, </span><span style="color: #0000BB">$count_query</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp; public function </span><span style="color: #0000BB">__construct</span><span style="color: #007700">(</span><span style="color: #0000BB">$source_type </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">, </span><span style="color: #0000BB">$dest_type </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">parent</span><span style="color: #007700">::</span><span style="color: #0000BB">__construct</span><span style="color: #007700">();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">description </span><span style="color: #007700">= </span><span style="color: #DD0000">"Migration of </span><span style="color: #007700">{</span><span style="color: #0000BB">$source_type</span><span style="color: #007700">}</span><span style="color: #DD0000"> nodes from atrium database"</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dependencies </span><span style="color: #007700">= array(</span><span style="color: #DD0000">'AtriumUser'</span><span style="color: #007700">, </span><span style="color: #DD0000">'AtriumFiles'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">map </span><span style="color: #007700">= new </span><span style="color: #0000BB">MigrateSQLMap</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">machineName</span><span style="color: #007700">, array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'nid' </span><span style="color: #007700">=&gt; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'int'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'not null' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'description' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'Source node ID'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ), </span><span style="color: #0000BB">MigrateDestinationNode</span><span style="color: #007700">::</span><span style="color: #0000BB">getKeySchema</span><span style="color: #007700">());<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">// Subquery used to select the first revision when importing nodes&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revisions'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n.nid = r.nid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'n.type'</span><span style="color: #007700">, </span><span style="color: #0000BB">$source_type</span><span style="color: #007700">, </span><span style="color: #DD0000">'='</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">groupBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'r.nid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addExpression</span><span style="color: #007700">(</span><span style="color: #DD0000">'MIN(r.vid)'</span><span style="color: #007700">, </span><span style="color: #DD0000">'vid'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">// Subquery to select file attachments (from uploads)<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'upload'</span><span style="color: #007700">, </span><span style="color: #DD0000">'u'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'u'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'vid'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addExpression</span><span style="color: #007700">(</span><span style="color: #DD0000">"GROUP_CONCAT(u.fid SEPARATOR ',')"</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">groupBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'u.vid'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revisions'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n.nid = r.nid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'url_alias'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a.src = CONCAT(\'node/\', n.nid)'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery</span><span style="color: #007700">, </span><span style="color: #DD0000">'minrev'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r.vid = minrev.vid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'n.type'</span><span style="color: #007700">, </span><span style="color: #0000BB">$source_type</span><span style="color: #007700">, </span><span style="color: #DD0000">'='</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">leftJoin</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids.vid = r.vid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'fids'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'fids'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'n'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'nid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'title'</span><span style="color: #007700">, </span><span style="color: #DD0000">'uid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'status'</span><span style="color: #007700">, </span><span style="color: #DD0000">'created'</span><span style="color: #007700">, </span><span style="color: #DD0000">'changed'</span><span style="color: #007700">, </span><span style="color: #DD0000">'comment'</span><span style="color: #007700">, </span><span style="color: #DD0000">'promote'</span><span style="color: #007700">, </span><span style="color: #DD0000">'sticky'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'r'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'body'</span><span style="color: #007700">, </span><span style="color: #DD0000">'teaser'</span><span style="color: #007700">, </span><span style="color: #DD0000">'log'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'a'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'dst'</span><span style="color: #007700">));<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revisions'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n.nid = r.nid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'url_alias'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a.src = CONCAT(\'node/\', n.nid)'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery</span><span style="color: #007700">, </span><span style="color: #DD0000">'minrev'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r.vid = minrev.vid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'n.type'</span><span style="color: #007700">, </span><span style="color: #0000BB">$source_type</span><span style="color: #007700">, </span><span style="color: #DD0000">'='</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">leftJoin</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids.vid = r.vid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addExpression</span><span style="color: #007700">(</span><span style="color: #DD0000">'COUNT(r.nid)'</span><span style="color: #007700">, </span><span style="color: #DD0000">'cnt'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">destination </span><span style="color: #007700">= new </span><span style="color: #0000BB">MigrateDestinationNode</span><span style="color: #007700">(</span><span style="color: #0000BB">$dest_type</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'text_format' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'markdown'</span><span style="color: #007700">));<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'uid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'uid'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #DD0000">'AtriumUser'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'revision_uid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'uid'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #DD0000">'AtriumUser'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'pathauto'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'revision'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'body'</span><span style="color: #007700">, </span><span style="color: #DD0000">'body'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'body:format'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #DD0000">'markdown'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'body:summary'</span><span style="color: #007700">, </span><span style="color: #DD0000">'teaser'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'field_files'</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #DD0000">'AtriumFiles'</span><span style="color: #007700">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'field_files:file_class'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #DD0000">'MigrateFileFid'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'path'</span><span style="color: #007700">, </span><span style="color: #DD0000">'dst'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addSimpleMappings</span><span style="color: #007700">(array(</span><span style="color: #DD0000">'log'</span><span style="color: #007700">, </span><span style="color: #DD0000">'sticky'</span><span style="color: #007700">, </span><span style="color: #DD0000">'promote'</span><span style="color: #007700">, </span><span style="color: #DD0000">'status'</span><span style="color: #007700">, </span><span style="color: #DD0000">'created'</span><span style="color: #007700">, </span><span style="color: #DD0000">'changed'</span><span style="color: #007700">, </span><span style="color: #DD0000">'comment'</span><span style="color: #007700">, </span><span style="color: #DD0000">'title'</span><span style="color: #007700">));<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addUnmigratedDestinations</span><span style="color: #007700">(array(</span><span style="color: #DD0000">'language'</span><span style="color: #007700">, </span><span style="color: #DD0000">'is_new'</span><span style="color: #007700">, </span><span style="color: #DD0000">'tnid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'body:language'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'field_files:language'</span><span style="color: #007700">, </span><span style="color: #DD0000">'field_files:description'</span><span style="color: #007700">, </span><span style="color: #DD0000">'field_files:display'</span><span style="color: #007700">));<br>&nbsp; }<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>There's some code in the example above to construct the SQL and select the first revision of nodes. This is important, as the revision migration will migrate the actual node bodies for the whole revision history. </p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">abstract class </span><span style="color: #0000BB">AtriumRevisionMigration </span><span style="color: #007700">extends </span><span style="color: #0000BB">Migration </span><span style="color: #007700">{<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; protected </span><span style="color: #0000BB">$query</span><span style="color: #007700">, </span><span style="color: #0000BB">$count_query</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp; <br>&nbsp; public function </span><span style="color: #0000BB">__construct</span><span style="color: #007700">(</span><span style="color: #0000BB">$source_type </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">, </span><span style="color: #0000BB">$dest_type </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">, </span><span style="color: #0000BB">$nid_map </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">parent</span><span style="color: #007700">::</span><span style="color: #0000BB">__construct</span><span style="color: #007700">();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">description </span><span style="color: #007700">= </span><span style="color: #DD0000">"Migration of </span><span style="color: #007700">{</span><span style="color: #0000BB">$source_type</span><span style="color: #007700">}</span><span style="color: #DD0000"> revisions from atrium database"</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dependencies </span><span style="color: #007700">= array(</span><span style="color: #DD0000">'AtriumUser'</span><span style="color: #007700">, </span><span style="color: #DD0000">'AtriumFiles'</span><span style="color: #007700">, </span><span style="color: #0000BB">$nid_map</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">map </span><span style="color: #007700">= new </span><span style="color: #0000BB">MigrateSQLMap</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">machineName</span><span style="color: #007700">, array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'vid' </span><span style="color: #007700">=&gt; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'int'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'not null' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'description' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'Source revision ID'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ), </span><span style="color: #0000BB">MigrateDestinationRevision</span><span style="color: #007700">::</span><span style="color: #0000BB">getKeySchema</span><span style="color: #007700">());<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">// Subquery to select file attachments (from uploads)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'upload'</span><span style="color: #007700">, </span><span style="color: #DD0000">'u'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'u'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'vid'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addExpression</span><span style="color: #007700">(</span><span style="color: #DD0000">"GROUP_CONCAT(u.fid SEPARATOR ',')"</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">groupBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'u.vid'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revisions'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n.nid = r.nid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'url_alias'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a.src = CONCAT(\'node/\', n.nid)'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'n.type'</span><span style="color: #007700">, </span><span style="color: #0000BB">$source_type</span><span style="color: #007700">, </span><span style="color: #DD0000">'='</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'n'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'nid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'title'</span><span style="color: #007700">, </span><span style="color: #DD0000">'uid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'status'</span><span style="color: #007700">, </span><span style="color: #DD0000">'created'</span><span style="color: #007700">, </span><span style="color: #DD0000">'comment'</span><span style="color: #007700">, </span><span style="color: #DD0000">'promote'</span><span style="color: #007700">, </span><span style="color: #DD0000">'sticky'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'r'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'body'</span><span style="color: #007700">, </span><span style="color: #DD0000">'vid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'teaser'</span><span style="color: #007700">, </span><span style="color: #DD0000">'log'</span><span style="color: #007700">, </span><span style="color: #DD0000">'timestamp'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'a'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'dst'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">leftJoin</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids.vid = r.vid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'fids'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'fids'</span><span style="color: #007700">));<br>&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revisions'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n.nid = r.nid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'url_alias'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a.src = CONCAT(\'node/\', n.nid)'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'n.type'</span><span style="color: #007700">, </span><span style="color: #0000BB">$source_type</span><span style="color: #007700">, </span><span style="color: #DD0000">'='</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addExpression</span><span style="color: #007700">(</span><span style="color: #DD0000">'COUNT(r.vid)'</span><span style="color: #007700">, </span><span style="color: #DD0000">'cnt'</span><span style="color: #007700">);<br>&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">destination </span><span style="color: #007700">= new </span><span style="color: #0000BB">MigrateDestinationRevision</span><span style="color: #007700">(</span><span style="color: #0000BB">$dest_type</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'text_format' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'markdown'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'nid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'nid'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #0000BB">$nid_map</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'field_files'</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #DD0000">'AtriumFiles'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'field_files:file_class'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #DD0000">'MigrateFileFid'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'uid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'uid'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #DD0000">'AtriumUser'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'revision_uid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'uid'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #DD0000">'AtriumUser'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'changed'</span><span style="color: #007700">, </span><span style="color: #DD0000">'timestamp'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'body'</span><span style="color: #007700">, </span><span style="color: #DD0000">'body'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'body:format'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #DD0000">'markdown'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'body:summary'</span><span style="color: #007700">, </span><span style="color: #DD0000">'teaser'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'pathauto'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'revision'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'path'</span><span style="color: #007700">, </span><span style="color: #DD0000">'dst'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addSimpleMappings</span><span style="color: #007700">(array(</span><span style="color: #DD0000">'log'</span><span style="color: #007700">, </span><span style="color: #DD0000">'sticky'</span><span style="color: #007700">, </span><span style="color: #DD0000">'promote'</span><span style="color: #007700">, </span><span style="color: #DD0000">'status'</span><span style="color: #007700">, </span><span style="color: #DD0000">'created'</span><span style="color: #007700">, </span><span style="color: #DD0000">'comment'</span><span style="color: #007700">, </span><span style="color: #DD0000">'title'</span><span style="color: #007700">));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addUnmigratedDestinations</span><span style="color: #007700">(array(</span><span style="color: #DD0000">'language'</span><span style="color: #007700">, </span><span style="color: #DD0000">'is_new'</span><span style="color: #007700">, </span><span style="color: #DD0000">'tnid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'body:language'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'field_files:language'</span><span style="color: #007700">, </span><span style="color: #DD0000">'field_files:description'</span><span style="color: #007700">, </span><span style="color: #DD0000">'field_files:display'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; public function </span><span style="color: #0000BB">complete</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">, </span><span style="color: #0000BB">$row</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">// Fix uid and timestamp in node_revisions.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$query </span><span style="color: #007700">= </span><span style="color: #0000BB">db_update</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revision'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'vid'</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">vid</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$fields</span><span style="color: #007700">[</span><span style="color: #DD0000">'timestamp'</span><span style="color: #007700">] = </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">changed</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$fields</span><span style="color: #007700">[</span><span style="color: #DD0000">'uid'</span><span style="color: #007700">] = </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">uid</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #0000BB">$fields</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">();<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; <br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>


</div>

</div>

<nav class="bg-grey-darker p-8 text-center text-sm">
  <ul class="list-reset">
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="/about">About</a>
    </li>
    <li class="mx-2 inline-block text-grey-lighter">&#9679;</li>
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="/contact">Contact</a>
    </li>
    <li class="mx-2 inline-block text-grey-lighter">&#9679;</li>
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="https://medium.com/@dazcyril">Stuff I've written on Medium</a>
    </li>
    <li class="mx-2 inline-block text-grey-lighter">&#9679;</li>
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="/blog">My old blog content</a>
    </li>
  </ul>
</nav>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script>
<script src="/js/scripts.js"></script>
</body>
</html>
