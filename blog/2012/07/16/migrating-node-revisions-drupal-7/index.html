<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title> Migrating Node Revisions to Drupal 7 |  Darren Mothersele</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <link rel="alternate" type="application/rss+xml" title="Darren Mothersele" href="http://www.darrenmothersele.com/rss.xml">
    
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>


<header id="header">
    <a href="/" class="image avatar"><img src="/img/darren100.jpg" alt="" /></a>
    <h1>
       <strong>Darren Mothersele</strong> </h1><h1> Creative Technologist
    </h1>

<ul class="menu-list">
    <li><a href="/about/">About me</a></li>
    <li><a href="/blog/">Blog</a></li>
    <li><a href="/contact/">Contact</a></li>
</ul>

</header>

<!-- <header>

<div class="top-nav">

<a href="/" class="top-nav-logo"><img src="/img/daz-logo.png" class="logo" alt="Logo" width="100"></a>

<ul class="menu menu-list">
    <li><a href="/about/">About me</a></li>
    <li><a href="/blog/">Blog</a></li>
    <li><a href="/contact/">Contact</a></li>
</ul>
</div>
<br clear="both">

</header> -->

<div id="main">
<div class="page">
  <header class="post-header">
<h2 class="post-title">Migrating Node Revisions to Drupal 7</h2>

  <p class="">16 Jul 2012</p>

  </header>


            
              <p class="lead">A while ago I was working on a migration from Open Atrium (Drupal 6) to Drupal 7. I decided to use the <a href="http://drupal.org/project/migrate">Migrate</a> module for this, as it provides a great framework for building migrations. Unfortunately the Migrate module doesn't (at the moment) support migrating of node revisions. There's discussion on the issue queue about migrating revisions <a href="http://drupal.org/node/1298724">here</a>. I quickly hacked together some working code that worked for me. I'm going to assume some prior knowledge of the Migrate module. If it's new to you, check out <a href="http://denver2012.drupal.org/program/sessions/getting-it-drupal-migrate">this presentation</a> from Drupalcon Dever which gives a good overview of the architecture.</p>



              
<p>The code below is working for me, and I'm using it to migrate content from Open Atrium to Drupal 7. The code does need some work, as it throws a few warning messages. It still migrates all nodes and revisions successfully, so it's usable if you're not a pedant :).</p>
<p>Migration using the Drupal Migrate module requires you to write some code. You can usually get away with using the provided Migration sources and destination handlers, and just write the code that handles the mapping of fields from source to target. In this case, I couldn't as the project required all history (revisions) to be migrated, and the standard <code>MigrateDestinationNode</code> class doesn't handle this. To get around this I first create a basic extension of the Node destination class to deal with revisions...</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">class </span><span style="color: #0000BB">MigrateDestinationRevision </span><span style="color: #007700">extends </span><span style="color: #0000BB">MigrateDestinationNode </span><span style="color: #007700">{<br>&nbsp; static public function </span><span style="color: #0000BB">getKeySchema</span><span style="color: #007700">() {<br>&nbsp;&nbsp;&nbsp; return array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'vid' </span><span style="color: #007700">=&gt; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'int'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'unsigned' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'description' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'ID of destination node revision'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br>&nbsp;&nbsp;&nbsp; );<br>&nbsp; }<br>&nbsp; public function </span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #0000BB">$migration </span><span style="color: #007700">= </span><span style="color: #0000BB">NULL</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$fields </span><span style="color: #007700">= </span><span style="color: #0000BB">parent</span><span style="color: #007700">::</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #0000BB">$migration</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$fields</span><span style="color: #007700">[</span><span style="color: #DD0000">'vid'</span><span style="color: #007700">] = </span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">'Node: &lt;a href="@doc"&gt;Revision (vid)&lt;/a&gt;'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'@doc' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'http://drupal.org/node/1298724'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp; return </span><span style="color: #0000BB">$fields</span><span style="color: #007700">;<br>&nbsp; }<br>&nbsp; public function </span><span style="color: #0000BB">bulkRollback</span><span style="color: #007700">(array </span><span style="color: #0000BB">$vids</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">migrate_instrument_start</span><span style="color: #007700">(</span><span style="color: #DD0000">'revision_delete_multiple'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">prepareRollback</span><span style="color: #007700">(</span><span style="color: #0000BB">$vids</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; foreach (</span><span style="color: #0000BB">$vids </span><span style="color: #007700">as </span><span style="color: #0000BB">$vid</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (</span><span style="color: #0000BB">$revision </span><span style="color: #007700">= </span><span style="color: #0000BB">node_load</span><span style="color: #007700">(</span><span style="color: #0000BB">NULL</span><span style="color: #007700">, </span><span style="color: #0000BB">$vid</span><span style="color: #007700">)) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">db_delete</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revision'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'vid'</span><span style="color: #007700">, </span><span style="color: #0000BB">$revision</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">vid</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">module_invoke_all</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revision_delete'</span><span style="color: #007700">, </span><span style="color: #0000BB">$revision</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">field_attach_delete_revision</span><span style="color: #007700">(</span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #0000BB">$revision</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">completeRollback</span><span style="color: #007700">(</span><span style="color: #0000BB">$vids</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">migrate_instrument_stop</span><span style="color: #007700">(</span><span style="color: #DD0000">'revision_delete_multiple'</span><span style="color: #007700">);<br>&nbsp; }<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>I'm overriding the key schema to make it aware of <code>vid</code> revision ids, and adding some code to take care of deleting all node revisions when I want to rollback a migration.</p>
<p>I then create the node migration, but instead of migrating the latest versions of the nodes, I craft the SQL so that it migrates all nodes, but does so with their first ever revisions. This migration runs before the revision migration. I create the revision migration and make the node revision migration a dependency of the revision migration. Here's the basics of the node migration, with the detail removed, notice that I'm using an abstract class, I have other concrete classes that instantiate the migration with an actual content type. This allows me to reuse as much mapping code as possible...</p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">abstract class </span><span style="color: #0000BB">AtriumNodeMigration </span><span style="color: #007700">extends </span><span style="color: #0000BB">Migration </span><span style="color: #007700">{<br>&nbsp;&nbsp;&nbsp; protected </span><span style="color: #0000BB">$query</span><span style="color: #007700">, </span><span style="color: #0000BB">$subquery</span><span style="color: #007700">, </span><span style="color: #0000BB">$count_query</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp; public function </span><span style="color: #0000BB">__construct</span><span style="color: #007700">(</span><span style="color: #0000BB">$source_type </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">, </span><span style="color: #0000BB">$dest_type </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">parent</span><span style="color: #007700">::</span><span style="color: #0000BB">__construct</span><span style="color: #007700">();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">description </span><span style="color: #007700">= </span><span style="color: #DD0000">"Migration of </span><span style="color: #007700">{</span><span style="color: #0000BB">$source_type</span><span style="color: #007700">}</span><span style="color: #DD0000"> nodes from atrium database"</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dependencies </span><span style="color: #007700">= array(</span><span style="color: #DD0000">'AtriumUser'</span><span style="color: #007700">, </span><span style="color: #DD0000">'AtriumFiles'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">map </span><span style="color: #007700">= new </span><span style="color: #0000BB">MigrateSQLMap</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">machineName</span><span style="color: #007700">, array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'nid' </span><span style="color: #007700">=&gt; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'int'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'not null' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'description' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'Source node ID'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ), </span><span style="color: #0000BB">MigrateDestinationNode</span><span style="color: #007700">::</span><span style="color: #0000BB">getKeySchema</span><span style="color: #007700">());<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">// Subquery used to select the first revision when importing nodes&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revisions'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n.nid = r.nid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'n.type'</span><span style="color: #007700">, </span><span style="color: #0000BB">$source_type</span><span style="color: #007700">, </span><span style="color: #DD0000">'='</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">groupBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'r.nid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addExpression</span><span style="color: #007700">(</span><span style="color: #DD0000">'MIN(r.vid)'</span><span style="color: #007700">, </span><span style="color: #DD0000">'vid'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">// Subquery to select file attachments (from uploads)<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'upload'</span><span style="color: #007700">, </span><span style="color: #DD0000">'u'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'u'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'vid'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addExpression</span><span style="color: #007700">(</span><span style="color: #DD0000">"GROUP_CONCAT(u.fid SEPARATOR ',')"</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">groupBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'u.vid'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revisions'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n.nid = r.nid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'url_alias'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a.src = CONCAT(\'node/\', n.nid)'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery</span><span style="color: #007700">, </span><span style="color: #DD0000">'minrev'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r.vid = minrev.vid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'n.type'</span><span style="color: #007700">, </span><span style="color: #0000BB">$source_type</span><span style="color: #007700">, </span><span style="color: #DD0000">'='</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">leftJoin</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids.vid = r.vid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'fids'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'fids'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'n'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'nid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'title'</span><span style="color: #007700">, </span><span style="color: #DD0000">'uid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'status'</span><span style="color: #007700">, </span><span style="color: #DD0000">'created'</span><span style="color: #007700">, </span><span style="color: #DD0000">'changed'</span><span style="color: #007700">, </span><span style="color: #DD0000">'comment'</span><span style="color: #007700">, </span><span style="color: #DD0000">'promote'</span><span style="color: #007700">, </span><span style="color: #DD0000">'sticky'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'r'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'body'</span><span style="color: #007700">, </span><span style="color: #DD0000">'teaser'</span><span style="color: #007700">, </span><span style="color: #DD0000">'log'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'a'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'dst'</span><span style="color: #007700">));<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revisions'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n.nid = r.nid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'url_alias'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a.src = CONCAT(\'node/\', n.nid)'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subquery</span><span style="color: #007700">, </span><span style="color: #DD0000">'minrev'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r.vid = minrev.vid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'n.type'</span><span style="color: #007700">, </span><span style="color: #0000BB">$source_type</span><span style="color: #007700">, </span><span style="color: #DD0000">'='</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">leftJoin</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids.vid = r.vid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addExpression</span><span style="color: #007700">(</span><span style="color: #DD0000">'COUNT(r.nid)'</span><span style="color: #007700">, </span><span style="color: #DD0000">'cnt'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">destination </span><span style="color: #007700">= new </span><span style="color: #0000BB">MigrateDestinationNode</span><span style="color: #007700">(</span><span style="color: #0000BB">$dest_type</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'text_format' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'markdown'</span><span style="color: #007700">));<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'uid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'uid'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #DD0000">'AtriumUser'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'revision_uid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'uid'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #DD0000">'AtriumUser'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'pathauto'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'revision'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'body'</span><span style="color: #007700">, </span><span style="color: #DD0000">'body'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'body:format'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #DD0000">'markdown'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'body:summary'</span><span style="color: #007700">, </span><span style="color: #DD0000">'teaser'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'field_files'</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #DD0000">'AtriumFiles'</span><span style="color: #007700">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'field_files:file_class'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #DD0000">'MigrateFileFid'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'path'</span><span style="color: #007700">, </span><span style="color: #DD0000">'dst'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addSimpleMappings</span><span style="color: #007700">(array(</span><span style="color: #DD0000">'log'</span><span style="color: #007700">, </span><span style="color: #DD0000">'sticky'</span><span style="color: #007700">, </span><span style="color: #DD0000">'promote'</span><span style="color: #007700">, </span><span style="color: #DD0000">'status'</span><span style="color: #007700">, </span><span style="color: #DD0000">'created'</span><span style="color: #007700">, </span><span style="color: #DD0000">'changed'</span><span style="color: #007700">, </span><span style="color: #DD0000">'comment'</span><span style="color: #007700">, </span><span style="color: #DD0000">'title'</span><span style="color: #007700">));<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addUnmigratedDestinations</span><span style="color: #007700">(array(</span><span style="color: #DD0000">'language'</span><span style="color: #007700">, </span><span style="color: #DD0000">'is_new'</span><span style="color: #007700">, </span><span style="color: #DD0000">'tnid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'body:language'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'field_files:language'</span><span style="color: #007700">, </span><span style="color: #DD0000">'field_files:description'</span><span style="color: #007700">, </span><span style="color: #DD0000">'field_files:display'</span><span style="color: #007700">));<br>&nbsp; }<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>There's some code in the example above to construct the SQL and select the first revision of nodes. This is important, as the revision migration will migrate the actual node bodies for the whole revision history. </p>
<p></p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">abstract class </span><span style="color: #0000BB">AtriumRevisionMigration </span><span style="color: #007700">extends </span><span style="color: #0000BB">Migration </span><span style="color: #007700">{<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; protected </span><span style="color: #0000BB">$query</span><span style="color: #007700">, </span><span style="color: #0000BB">$count_query</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp; <br>&nbsp; public function </span><span style="color: #0000BB">__construct</span><span style="color: #007700">(</span><span style="color: #0000BB">$source_type </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">, </span><span style="color: #0000BB">$dest_type </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">, </span><span style="color: #0000BB">$nid_map </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">parent</span><span style="color: #007700">::</span><span style="color: #0000BB">__construct</span><span style="color: #007700">();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">description </span><span style="color: #007700">= </span><span style="color: #DD0000">"Migration of </span><span style="color: #007700">{</span><span style="color: #0000BB">$source_type</span><span style="color: #007700">}</span><span style="color: #DD0000"> revisions from atrium database"</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">dependencies </span><span style="color: #007700">= array(</span><span style="color: #DD0000">'AtriumUser'</span><span style="color: #007700">, </span><span style="color: #DD0000">'AtriumFiles'</span><span style="color: #007700">, </span><span style="color: #0000BB">$nid_map</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">map </span><span style="color: #007700">= new </span><span style="color: #0000BB">MigrateSQLMap</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">machineName</span><span style="color: #007700">, array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'vid' </span><span style="color: #007700">=&gt; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'int'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'not null' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'description' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'Source revision ID'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ), </span><span style="color: #0000BB">MigrateDestinationRevision</span><span style="color: #007700">::</span><span style="color: #0000BB">getKeySchema</span><span style="color: #007700">());<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">// Subquery to select file attachments (from uploads)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'upload'</span><span style="color: #007700">, </span><span style="color: #DD0000">'u'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'u'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'vid'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addExpression</span><span style="color: #007700">(</span><span style="color: #DD0000">"GROUP_CONCAT(u.fid SEPARATOR ',')"</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">groupBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'u.vid'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revisions'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n.nid = r.nid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'url_alias'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a.src = CONCAT(\'node/\', n.nid)'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'n.type'</span><span style="color: #007700">, </span><span style="color: #0000BB">$source_type</span><span style="color: #007700">, </span><span style="color: #DD0000">'='</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'n'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'nid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'title'</span><span style="color: #007700">, </span><span style="color: #DD0000">'uid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'status'</span><span style="color: #007700">, </span><span style="color: #DD0000">'created'</span><span style="color: #007700">, </span><span style="color: #DD0000">'comment'</span><span style="color: #007700">, </span><span style="color: #DD0000">'promote'</span><span style="color: #007700">, </span><span style="color: #DD0000">'sticky'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'r'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'body'</span><span style="color: #007700">, </span><span style="color: #DD0000">'vid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'teaser'</span><span style="color: #007700">, </span><span style="color: #DD0000">'log'</span><span style="color: #007700">, </span><span style="color: #DD0000">'timestamp'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'a'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'dst'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">leftJoin</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">file_query</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids.vid = r.vid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #DD0000">'fids'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'fids'</span><span style="color: #007700">));<br>&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query </span><span style="color: #007700">= </span><span style="color: #0000BB">Database</span><span style="color: #007700">::</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">(</span><span style="color: #DD0000">'default'</span><span style="color: #007700">, </span><span style="color: #DD0000">'atrium'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revisions'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n'</span><span style="color: #007700">, </span><span style="color: #DD0000">'n.nid = r.nid'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">'url_alias'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a'</span><span style="color: #007700">, </span><span style="color: #DD0000">'a.src = CONCAT(\'node/\', n.nid)'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'n.type'</span><span style="color: #007700">, </span><span style="color: #0000BB">$source_type</span><span style="color: #007700">, </span><span style="color: #DD0000">'='</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">count_query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addExpression</span><span style="color: #007700">(</span><span style="color: #DD0000">'COUNT(r.vid)'</span><span style="color: #007700">, </span><span style="color: #DD0000">'cnt'</span><span style="color: #007700">);<br>&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">destination </span><span style="color: #007700">= new </span><span style="color: #0000BB">MigrateDestinationRevision</span><span style="color: #007700">(</span><span style="color: #0000BB">$dest_type</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'text_format' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'markdown'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'nid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'nid'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #0000BB">$nid_map</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'field_files'</span><span style="color: #007700">, </span><span style="color: #DD0000">'fids'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #DD0000">'AtriumFiles'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'field_files:file_class'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #DD0000">'MigrateFileFid'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'uid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'uid'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #DD0000">'AtriumUser'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'revision_uid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'uid'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">sourceMigration</span><span style="color: #007700">(</span><span style="color: #DD0000">'AtriumUser'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'changed'</span><span style="color: #007700">, </span><span style="color: #DD0000">'timestamp'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'body'</span><span style="color: #007700">, </span><span style="color: #DD0000">'body'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'body:format'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #DD0000">'markdown'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'body:summary'</span><span style="color: #007700">, </span><span style="color: #DD0000">'teaser'</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'pathauto'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'revision'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">defaultValue</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addFieldMapping</span><span style="color: #007700">(</span><span style="color: #DD0000">'path'</span><span style="color: #007700">, </span><span style="color: #DD0000">'dst'</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addSimpleMappings</span><span style="color: #007700">(array(</span><span style="color: #DD0000">'log'</span><span style="color: #007700">, </span><span style="color: #DD0000">'sticky'</span><span style="color: #007700">, </span><span style="color: #DD0000">'promote'</span><span style="color: #007700">, </span><span style="color: #DD0000">'status'</span><span style="color: #007700">, </span><span style="color: #DD0000">'created'</span><span style="color: #007700">, </span><span style="color: #DD0000">'comment'</span><span style="color: #007700">, </span><span style="color: #DD0000">'title'</span><span style="color: #007700">));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">addUnmigratedDestinations</span><span style="color: #007700">(array(</span><span style="color: #DD0000">'language'</span><span style="color: #007700">, </span><span style="color: #DD0000">'is_new'</span><span style="color: #007700">, </span><span style="color: #DD0000">'tnid'</span><span style="color: #007700">, </span><span style="color: #DD0000">'body:language'</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'field_files:language'</span><span style="color: #007700">, </span><span style="color: #DD0000">'field_files:description'</span><span style="color: #007700">, </span><span style="color: #DD0000">'field_files:display'</span><span style="color: #007700">));<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; public function </span><span style="color: #0000BB">complete</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">, </span><span style="color: #0000BB">$row</span><span style="color: #007700">) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">// Fix uid and timestamp in node_revisions.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$query </span><span style="color: #007700">= </span><span style="color: #0000BB">db_update</span><span style="color: #007700">(</span><span style="color: #DD0000">'node_revision'</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;</span><span style="color: #0000BB">condition</span><span style="color: #007700">(</span><span style="color: #DD0000">'vid'</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">vid</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$fields</span><span style="color: #007700">[</span><span style="color: #DD0000">'timestamp'</span><span style="color: #007700">] = </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">changed</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$fields</span><span style="color: #007700">[</span><span style="color: #DD0000">'uid'</span><span style="color: #007700">] = </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">uid</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fields</span><span style="color: #007700">(</span><span style="color: #0000BB">$fields</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">();<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; <br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>

            

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'darrenmothersele';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>







<p>
    <i class="icon">&#128681;</i>
    Brixton, London, UK
    <br>
    <i class="icon">&#9993;</i>
    <script type="text/javascript">
    var data = "&#100;&#97;&#114;&#114;&#101;&#110;&#64;&#100;&#97;&#114;"
    + "&#114;&#101;&#110;&#109;&#111;&#116;&#104;&#101;&#114;&#115;&#101;"
    + "&#108;&#101;&#46;&#99;&#111;&#109;";
    document.write(data);
    </script>
</p>

<div class="my-tinyletter">
    <h4>Updates...</h4>
<form action="https://tinyletter.com/dazm" method="post">
    <p>
        <label for="tlemail">To get my 'friends and family' newsletter, enter your email address:</label>
    </p>
    <p>
        <input type="text" name="email" id="tlemail" placeholder="Email" /><br>
        <input type="hidden" value="1" name="embed"/>
        <input type="submit" value="Subscribe" /><br>
        <a href="https://tinyletter.com" target="_blank" style="font-size:75%;">
            powered by TinyLetter
        </a>
    </p>
</form>



</div>



</div>
</div>

<!-- <footer>



<div class="footer">

<p>
    <i class="icon">&#128681;</i>
    Brixton, London, UK
    <br>
    <i class="icon">&#9993;</i>
    <script type="text/javascript">
    var data = "&#100;&#97;&#114;&#114;&#101;&#110;&#64;&#100;&#97;&#114;"
    + "&#114;&#101;&#110;&#109;&#111;&#116;&#104;&#101;&#114;&#115;&#101;"
    + "&#108;&#101;&#46;&#99;&#111;&#109;";
    document.write(data);
    </script>
</p>

<div class="my-tinyletter">
<form action="https://tinyletter.com/dazm" method="post">
    <p>
        <label for="tlemail">To get my 'friends and family' newsletter, enter your email address:</label>
    </p>
    <p>
        <input type="text" style="width:140px" name="email" id="tlemail" />
        <input type="hidden" value="1" name="embed"/>
        <input type="submit" value="Subscribe" /><br>
        <a href="https://tinyletter.com" target="_blank" style="font-size:75%;">
            powered by TinyLetter
        </a>
    </p>
</form>
</div>


<ul class="social-icons text-right menu-list hidden-sm">


    <li><a href="https://twitter.com/mothersele"><i class="icon-twitter3"></i> Twitter</a></li>

    <li><a href="https://github.com/darrenmothersele/"><i class="icon-github"></i> GitHub</a></li>

    <li><a href="https://vimeo.com/user437927"><i class="icon-vimeo3"></i> Vimeo</a></li>

    <li><a href="https://uk.linkedin.com/in/dmothersele"><i class="icon-linkedin2"></i> LinkedIn</a></li>


</ul>


<ul class="menu-list">
    <li><a href="/contact/">Contact</a></li>
    <li><a href="/about/">About</a></li>
    <li><a href="/training/">Training</a></li>
    <li><a href="/blog/">Blog</a></li>
</ul>

<p class="sub">
    <small>
        &copy;2007-2015 Darren Mothersele.
        Unless specified otherwise, content is licensed under a
        <a class="text-white" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative
            Commons Attribution-ShareAlike 3.0 Unported License</a>.


        Source code is either released into the public domain, or under
        an MIT / BSD license where possible. If this is not possible
        (due to restrictions of the GPL) then code will be released
        as GPL. See individual project license files for details.
    </small>
</p>
</div>

</footer> -->


<footer id="footer">
    <ul class="icons">
        <li><a href="https://twitter.com/mothersele" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
        <li><a href="https://github.com/darrenmothersele" class="icon fa-github"><span class="label">Github</span></a></li>
        <li><a href="#" class="icon fa-envelope-o"><span class="label">
    <script type="text/javascript">
    var data = "&#100;&#97;&#114;&#114;&#101;&#110;&#64;&#100;&#97;&#114;"
    + "&#114;&#101;&#110;&#109;&#111;&#116;&#104;&#101;&#114;&#115;&#101;"
    + "&#108;&#101;&#46;&#99;&#111;&#109;";
    document.write(data);
    </script></span></a></li>
    </ul>
    <ul class="copyright">
        <li>
        &copy;2007-2016 Darren Mothersele.
        Unless specified otherwise, content is licensed under a
        <a class="text-white" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative
            Commons Attribution-ShareAlike 3.0 Unported License</a>.</li>
    </ul>
</footer>

</body>
</html>
