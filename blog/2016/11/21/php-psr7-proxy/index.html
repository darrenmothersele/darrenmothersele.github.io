<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>PHP PSR-7 Proxy | Darren Mothersele</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-grey-lightest text-black">

<header class="py-4 overflow-hidden flex justify-center items-center border-b">
  <div class="flex-1 border-r h-8 skew-right grad-right"></div>
  <a class="no-outline" href="/">
    <svg id="logo" class="h-8 mx-8" viewBox="0 0 1140 400" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;"><path d="M60,300l60,100l-120,0l60,-100Z" style="fill:#b35738;"/><path d="M120,200l60,100l-120,0l60,-100Z" style="fill:#cf7038;"/><path d="M180,100l60,100l-120,0l60,-100Z" style="fill:#c46f3c;"/><path d="M240,0l60,100l-120,0l60,-100Z" style="fill:#d5a246;"/><path d="M360,0l60,100l-120,0l60,-100Z" style="fill:#ddc55e;"/><path d="M480,0l60,100l-120,0l60,-100Z" style="fill:#d8c571;"/><path d="M420,100l60,100l-120,0l60,-100Z" style="fill:#d5b74c;"/><path d="M180,300l60,100l-120,0l60,-100Z" style="fill:#da7535;"/><path d="M300,300l60,100l-120,0l60,-100Z" style="fill:#dd8d3d;"/><path d="M360,200l60,100l-120,0l60,-100Z" style="fill:#dda446;"/><path d="M420,300l60,100l-120,0l60,-100Z" style="fill:#826c85;"/><path d="M480,200l60,100l-120,0l60,-100Z" style="fill:#b8415b;"/><path d="M540,100l60,100l-120,0l60,-100Z" style="fill:#db3846;"/><path d="M600,0l60,100l-120,0l60,-100Z" style="fill:#e65041;"/><path d="M660,100l60,100l-120,0l60,-100Z" style="fill:#e92d41;"/><path d="M540,300l60,100l-120,0l60,-100Z" style="fill:#ce5772;"/><path d="M660,300l60,100l-120,0l60,-100Z" style="fill:#e7536b;"/><path d="M720,200l60,100l-120,0l60,-100Z" style="fill:#da2451;"/><path d="M780,300l60,100l-120,0l60,-100Z" style="fill:#c74a62;"/><path d="M840,200l60,100l-120,0l60,-100Z" style="fill:#02aeb0;"/><path d="M900,300l60,100l-120,0l60,-100Z" style="fill:#08a4a5;"/><path d="M960,400l60,-100l-120,0l60,100Z" style="fill:#0a969f;"/><path d="M840,400l60,-100l-120,0l60,100Z" style="fill:#05a9a9;"/><path d="M720,400l60,-100l-120,0l60,100Z" style="fill:#e62e4f;"/><path d="M600,400l60,-100l-120,0l60,100Z" style="fill:#e23a57;"/><path d="M480,400l60,-100l-120,0l60,100Z" style="fill:#a7506b;"/><path d="M240,400l60,-100l-120,0l60,100Z" style="fill:#dc8b3a;"/><path d="M360,400l60,-100l-120,0l60,100Z" style="fill:#dd9442;"/><path d="M120,400l60,-100l-120,0l60,100Z" style="fill:#cf6636;"/><path d="M180,300l60,-100l-120,0l60,100Z" style="fill:#d6883c;"/><path d="M240,200l60,-100l-120,0l60,100Z" style="fill:#d08a42;"/><path d="M300,100l60,-100l-120,0l60,100Z" style="fill:#ddbb49;"/><path d="M420,100l60,-100l-120,0l60,100Z" style="fill:#d1bd56;"/><path d="M480,200l60,-100l-120,0l60,100Z" style="fill:#d6bf61;"/><path d="M420,300l60,-100l-120,0l60,100Z" style="fill:#d9af48;"/><path d="M540,300l60,-100l-120,0l60,100Z" style="fill:#d1354f;"/><path d="M600,200l60,-100l-120,0l60,100Z" style="fill:#e53843;"/><path d="M660,300l60,-100l-120,0l60,100Z" style="fill:#d80b2c;"/><path d="M780,100l60,-100l-120,0l60,100Z" style="fill:#128c83;"/><path d="M900,100l60,-100l-120,0l60,100Z" style="fill:#12617a;"/><path d="M960,200l60,-100l-120,0l60,100Z" style="fill:#09889a;"/><path d="M900,300l60,-100l-120,0l60,100Z" style="fill:#03a4ae;"/><path d="M1080,400l60,-100l-120,0l60,100Z" style="fill:#107a8e;"/><path d="M1020,300l60,100l-120,0l60,-100Z" style="fill:#0d8b96;"/><path d="M900,100l60,100l-120,0l60,-100Z" style="fill:#04a1a9;"/><path d="M960,0l60,100l-120,0l60,-100Z" style="fill:#125776;"/><path d="M840,0l60,100l-120,0l60,-100Z" style="fill:#0d8088;"/><path d="M720,0l60,100l-120,0l60,-100Z" style="fill:#169b8c;"/></svg>
  </a>
  <div class="flex-1 border-l h-8 skew-left grad-left"></div>
</header>

<div id="me">
  <div class="py-8 flex justify-center items-center">
    <div class="border rounded-full p-1">
      <img class="rounded-full block" width="100" height="100"
           src="/images/darren100.jpg">
    </div>
  </div>

  <div class="text-center">

    <h1 class="text-2xl">Darren Mothersele</h1>

    <p>Software Developer</p>

  </div>
</div>

<div id="page" class="my-8 font-serif leading-normal">
  <div>
  <p class="border-4 border-red p-8 bg-red-light m-8 text-white">
    <b>Warning:</b> You are viewing old, legacy content.
    Kept for posterity.
    Information is out of date.
    Code samples probably don't work.
    My opinions have probably changed.
    Browse at your own risk.
  </p>
</div>


<div class="m-8">
  <h1>PHP PSR-7 Proxy</h1>
  
  <p>Nov 21, 2016</p>
  
  
  <p class="text-sm uppercase">Web Dev</p>
  
</div>



<div class="m-8 legacy-content font-serif">
  <p>Creating a proxy in PHP is easy thanks to the 
<a href="http://www.php-fig.org/psr/psr-7/">PSR-7 HTTP message interface</a> 
definitions.</p>

<p>Different tools using these same interface definitions are
interoperable, without any extra work. 
With PSR-7 it is easy to write a simple proxy. 
Like this one, that sits between a client and an API and
performs some mapping and reformatting of the data.</p>

<p>If you’d rather read the code than the description
go to <a href="https://github.com/darrenmothersele/php-psr7-proxy">this GitHub repo</a>.</p>

<p>I use the <a href="http://docs.guzzlephp.org/en/latest/">Guzzle</a> 
HTTP client to make API calls in my code.
This works with HTTP message objects that conform to PSR-7.</p>

<p>Symfony HTTP Foundation (as used in Drupal) can work with
PSR-7, but needs the PSR-7 Bridge library added.
So, for simple projects, I prefer to use a standalone 
implementation of PSR-7 like 
<a href="https://zendframework.github.io/zend-diactoros/">Zend Diactoros</a>.</p>

<p>On simple projects I tend to use <a href="http://php-di.org/">PHP-DI</a> 
to configure everything. So, a simple <code class="highlighter-rouge">composer.json</code> file 
for this project might look something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "require": {
        "php-di/php-di": "^5.4",
        "guzzlehttp/guzzle": "^6.2",
        "zendframework/zend-diactoros": "^1.3",
        "mtdowling/jmespath.php": "^2.3"
    },
    "autoload": {
        "psr-4": {
            "MyProxy\\": "src"
        }
    }
}
</code></pre></div></div>

<p>I’ve added <a href="https://github.com/jmespath/jmespath.php">JMESPath</a> 
to perform data manipulation.</p>

<p>I put some standard bootstrap stuff into an App class. In the
simplest of cases this just builds the DI container, and 
provides a <code class="highlighter-rouge">run()</code> method.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class App
{
    /** @var Container */
    protected $container;

    public function __construct()
    {
        $builder = new ContainerBuilder;
        $builder-&gt;addDefinitions(__DIR__.'/di-config.php');
        $this-&gt;container = $builder-&gt;build();
    }

    public function run(ServerRequestInterface $request, ResponseInterface $response)
    {
        $runner = $this-&gt;container-&gt;get(StackRunner::class);
        return $runner($request, $response);
    }
}
</code></pre></div></div>

<p>This uses the Container from PHP-DI, and makes use of the 
<code class="highlighter-rouge">StackRunner</code> class I talked about in 
<a href="http://www.darrenmothersele.com/blog/2016/09/02/tiny-php-microframework-in-40-lines/">a previous blog post</a></p>

<p>The <code class="highlighter-rouge">StackRunner</code> is given a stack of middleware to process requests. 
They are configured in the <code class="highlighter-rouge">di-config.php</code> file that is loaded
into PHP-DI’s container. 
Here’s my example config for a very simple proxy that forwards
requests to an API, then does some manipulation of the data
it receives before sending the reply back to the client.</p>

<p>Here’s the DI config, simplified to show the important bits:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return [

    'target' =&gt; 'http://example.com',

    'middleware' =&gt; [
        ProxyMiddleware::class,
        FilterMiddleware::class
    ],

    StackRunner::class =&gt; object()
        -&gt;constructorParameter('stack', get('middleware')),

    ProxyMiddleware::class =&gt; object()
        -&gt;constructorParameter('target', get('target')),
];
</code></pre></div></div>

<p>In this example the middleware stack contains just two items. 
The first one proxies the request, the second one applies
a filter to the response, before returning.</p>

<p>The actual implementation of <code class="highlighter-rouge">ProxyMiddleware</code> is very 
straightforward, because of the use of compatible PSR-7 
http message objects.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class ProxyMiddleware
{
    /** @var Client */
    protected $client;

    protected $target;

    public function __construct(Client $client, $target)
    {
        $this-&gt;client = $client;
        $this-&gt;target = $target;
    }

    public function __invoke(ServerRequestInterface $request, ResponseInterface $response, callable $next)
    {
        $target = new Uri($this-&gt;target);

        /** @var Uri $uri */
        $uri = $request-&gt;getUri()
            -&gt;withScheme($target-&gt;getScheme())
            -&gt;withHost($target-&gt;getHost())
            -&gt;withPort($target-&gt;getPort());

        $request = $request-&gt;withUri($uri);

        $response = $this-&gt;client-&gt;send($request);

        return $next($request, $response);
    }
}
</code></pre></div></div>

<p>Notice the <code class="highlighter-rouge">ServerRequestInterface</code> object it reused to
send on to the API via the Guzzle HTTP client.
I just reset the URI of the request and send it on.
You might want to do more than this when manipulating the
requests before passing them on, like removing/adding cookies.</p>

<p>The <code class="highlighter-rouge">FilterMiddleware</code> is just as simple…</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class FilterMiddleware
{
    public function __invoke(ServerRequestInterface $request, ResponseInterface $response, $next)
    {
        $data = json_decode($response-&gt;getBody()-&gt;getContents(), true);
        
        // Do your manipulation of data here
        
        $response = new JsonResponse($data);
        return $next($request, $response);
    }
}
</code></pre></div></div>

<p>The point of this article is not to discuss the 
filtering and manipulating the data so I have omitted 
those bits of the code. I actually pass in an object to do 
the filtering, via the DI config. 
Which makes this middleware reusable.</p>

<p>The important point I wanted to highlight was just how
easy it is to make a simple proxy using PSR-7 for
compatibility.</p>

<p>Here is how it is used, by creating a Diactoros 
<code class="highlighter-rouge">ServerRequestInterface</code> object from the incoming PHP
request, and using the <code class="highlighter-rouge">SapiEmitter</code> to output the
response. Here’s my <code class="highlighter-rouge">proxy.php</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require_once __DIR__.'/../vendor/autoload.php';

$request = ServerRequestFactory::fromGlobals();
$response = (new App)-&gt;run($request, new Response);
(new SapiEmitter)-&gt;emit($response);
</code></pre></div></div>

<p>You can run this with PHP’s internal web server,
by calling <code class="highlighter-rouge">php -S localhost:8080 proxy.php</code>.</p>

<p>You can get the example code from 
<a href="https://github.com/darrenmothersele/php-psr7-proxy">this GitHub repo</a>.</p>


</div>

</div>

<nav class="bg-grey-darker p-8 text-center text-sm">
  <ul class="list-reset">
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="/about">About</a>
    </li>
    <li class="mx-2 inline-block text-grey-lighter">&#9679;</li>
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="/contact">Contact</a>
    </li>
    <li class="mx-2 inline-block text-grey-lighter">&#9679;</li>
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="https://medium.com/@dazcyril">Stuff I've written on Medium</a>
    </li>
    <li class="mx-2 inline-block text-grey-lighter">&#9679;</li>
    <li class="mx-2 inline-block">
      <a class="text-grey-lighter no-underline hover:underline" href="/blog">My old blog content</a>
    </li>
  </ul>
</nav>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script>
<script src="/js/scripts.js"></script>
</body>
</html>
